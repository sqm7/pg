Gemini

2.5 Pro

Invite a friend


PRO


設

山


Conversation with Gemini


query-sub-data
TS

query-names
TS

query-data
TS

analyze-pr...ct-ranking
TS

cors
TS

unit-parser
TS

前端篩選資料v20(新增單價分析)
RTF
房屋單價分析的圖表 住宅、店舖、事務所的房屋平均單價跟核心指標排名的均價有點微差



Show thinking
好的，這是一個非常專業的觀察。您發現「房屋單價分析」中的各類型均價與「核心指標排名」的總均價存在微小差異，這是正常且符合預期的，根本原因在於兩者的計算方式與資料範圍不同。

以下將根據您提供的程式碼，詳細拆解兩者之間的差異。

核心差異：加權平均 vs. 算術平均
簡單來說，兩者的主要區別如下：

指標項目

計算方式

計算基礎 (資料範圍)

分析目的

核心指標與排名均價

加權平均 (總房屋總價 / 總房屋面積)

涵蓋所有符合篩選條件的交易，不論建物型態。

反映市場整體的**「每坪均價」**的真實價值，坪數大的交易影響力更高。

房屋單價分析均價

算術平均 (各筆交易單價加總 / 總筆數)

僅針對特定建物型態 (如住宅大樓/華廈) 進行篩選。

觀察特定產品類型在市場上**「平均一筆交易的單價」**是多少，每筆交易權重相同。


Export to Sheets
程式碼追蹤分析
1. 核心指標與排名均價 (加權平均)
在後端檔案 analyze-project-ranking.ts 中，這個均價是這樣計算的：

整體市場平均單價 (overallAveragePrice):

程式碼會累加所有符合初步篩選條件（縣市、日期等）資料的 房屋總價(萬) 和 房屋面積(坪)。

最終計算方式為：overallAveragePrice = 總房屋總價 / 總房屋面積。

TypeScript

// 檔案: analyze-project-ranking.ts
// ...
let totalHouseArea = 0, totalHousePrice = 0;
allRawData.forEach(r => {
  // ...
  totalHouseArea += r['房屋面積(坪)'] || 0;
  totalHousePrice += r['房屋總價(萬)'] || 0;
});
const coreMetrics = {
  // ...
  overallAveragePrice: parseFloat(safeDivide(totalHousePrice, totalHouseArea).toFixed(2)),
  // ...
};
各建案平均單價 (averagePrice):

邏輯相同，但範圍縮小到單一建案。

計算方式為：averagePrice = 該建案的總房屋總價 / 該建案的總房屋面積。

TypeScript

// 檔案: analyze-project-ranking.ts
// ...
const projectRanking = Array.from(projectGroups.entries()).map(([projectName, group]) => {
    // ...
    return {
        // ...
        averagePrice: parseFloat(safeDivide(group.housePriceSum, group.houseAreaSum).toFixed(2)),
        // ...
    }; 
});
關鍵點: 這種加權平均的方式，會讓「高總價」或「大坪數」的交易對整體平均價格產生更大的影響。它並未排除任何建物型態（除非您在前端有篩選），所以住宅、店舖、事務所的數據是混合計算的。

2. 房屋單價分析均價 (算術平均)
在同一個後端檔案 analyze-project-ranking.ts 的 【新增】計算房屋單價分析 區塊，計算邏輯則完全不同：

住宅單價統計 (residentialStats):

第一步：嚴格篩選資料。程式碼只會挑出 建物型態 為 住宅大樓(11層含以上有電梯) 或 華廈(10層含以下有電梯) 的交易，並確保 房屋單價(萬) 是有效的數字。

TypeScript

// 檔案: analyze-project-ranking.ts
const residentialTypes = ['住宅大樓(11層含以上有電梯)', '華廈(10層含以下有電梯)'];
const residentialData = allRawData.filter(r => 
    residentialTypes.includes(r['建物型態']) && typeof r['房屋單價(萬)'] === 'number' && r['房屋單價(萬)'] > 0
);
第二步：算術平均。將篩選後每筆交易的 房屋單價(萬) 直接相加，再除以總筆數。

TypeScript

// 檔案: analyze-project-ranking.ts
if (sortedResidentialUnitPrices.length > 0) {
    const sum = sortedResidentialUnitPrices.reduce((a, b) => a + b, 0);
    // ...
    residentialStats = {
        avgPrice: safeDivide(sum, sortedResidentialUnitPrices.length),
        // ...
    };
}
建案類型比較 (店舖/事務所):

第一步：分組。程式碼會將資料依 建物型態 包含的關鍵字（如 店舖、事務所）進行分組。

第二步：算術平均。與住宅統計一樣，計算每個分類下所有交易的 房屋單價(萬) 的算術平均值。

TypeScript

// 檔案: analyze-project-ranking.ts
const residentialAvg = safeDivide(group['住宅'].sum, group['住宅'].count);
const shopAvg = safeDivide(group['店舖'].sum, group['店舖'].count);
const officeAvg = safeDivide(group['事務所'].sum, group['事務所'].count);
關鍵點: 這種方式是計算「單價欄位」的平均值，而不是透過總價和總面積去推算。每筆交易的權重都是一樣的，且資料經過嚴格的 建物型態 篩選，這就是造成數值差異最主要的原因。

結論
您的觀察完全正確，這個差異是數據分析方法不同所導致的，並非 Bug。

核心指標均價：提供一個 宏觀的、加權的 市場視角。它告訴您在您篩選的範圍內，市場上平均花一筆錢能買到多少面積的房地產，更貼近市場總體的資金流向。

單價分析均價：提供一個 微觀的、分類的 產品視角。它告訴您「住宅」、「店舖」等特定產品，平均每筆交易的成交單價落點在哪裡，更適合用於比較不同產品間的價格差異。

這兩種指標各有其分析價值，同時呈現能讓您對市場有更全面、更立體的理解。






核心指標與排名均價. 但我上面的篩選 有選擇店舖



Show thinking
您提出了一個非常好的情境，這能讓我們更精準地釐清問題。

當您在最上方的篩選器選擇了「店面(店鋪)」，

analyze-project-ranking 函式確實會在一開始就只從資料庫撈取「店面」的資料 。在這種情況下，後續兩種計算的


資料基礎是完全相同的。

然而，您依然會看到兩者均價的差異，這完全是由於「計算方法的根本不同」所造成的。

即使資料範圍相同，兩種均價的計算公式和分析角度也完全不同：

指標 (Indicator)

計算公式 (Formula)

特性 (Characteristic)

核心指標均價

(所有店舖的房屋總價加總) / (所有店舖的房屋面積加總)

這是 加權平均 (Weighted Average)。面積較大的店舖，其價格對最終平均值的影響就越大。它回答的問題是：「在您篩選的範圍內，店舖市場平均每坪的價值是多少？」

單價分析的店舖均價

(所有店舖的「房屋單價」欄位加總) / (店舖總筆數)

這是 算術平均 (Simple Mean)。每一筆店舖交易的權重都相等，無論其面積大小。它回答的問題是：「在您篩選的範圍內，平均一筆店舖交易的單價是多少？」


Export to Sheets
用一個簡單的例子說明
假設篩選後，市場上只有 2 筆 店舖交易資料：

店舖 A (大坪數):

房屋總價: 10,000 萬

房屋面積: 100 坪

房屋單價: 100 萬/坪

店舖 B (小坪數):

房屋總價: 1,200 萬

房屋面積: 10 坪

房屋單價: 120 萬/坪

現在我們用這兩筆完全相同的資料，來計算兩種均價：

1. 核心指標均價 (加權平均)
總價加總: 10,000 萬 + 1,200 萬 = 11,200 萬

面積加總: 100 坪 + 10 坪 = 110 坪

計算結果: 11,200 / 110 = 101.82 萬/坪

可以看到，坪數大的店舖A (單價較低) 把整體平均值往下拉了。

2. 房屋單價分析均價 (算術平均)
單價加總: 100 萬/坪 + 120 萬/坪 = 220 萬/坪

總筆數: 2 筆

計算結果: 220 / 2 = 110.00 萬/坪

這裡，兩筆交易的權重是完全一樣的。

結論
即使您在最上方篩選了「店面」，讓資料來源完全一致，但由於「核心指標」採用的是考慮面積權重的加權平均法，而「單價分析」採用的是不考慮權重的算術平均法，兩者計算出的結果幾乎總會存在差異。

這並非錯誤，而是報表設計上刻意提供的兩種不同分析維度，讓您可以同時觀察到市場的「每坪價值」與「平均交易單價」。


Sources





這樣分開的原因是什麼，可以請你教我嗎



Show thinking
當然可以！這是一個非常好的問題。將這兩種均價分開呈現，是為了提供您從宏觀到微觀，從**「市場整體價值」到「普遍交易行情」**的兩種不同但互補的分析視角。

把它們分開，能幫助您更深入地洞察市場，避免被單一數字誤導。

我們可以把它想像成分析一個公司的薪資水平：

加權平均 (核心指標均價) 就像是計算公司的 「總薪資支出 / 總員工人數」。如果公司有幾個薪水極高的頂級主管，這個平均數就會被拉高，它反映的是公司整體的「人力成本結構」。

算術平均 (單價分析均價) 就像是把每個員工的薪水加總後 / 總員工人數。這個數字更能代表一個「普通員工」大概的薪資落點，比較不受極端高薪的影響。

在房地產分析中，這兩種指標分別扮演以下重要角色：

1. 核心指標均價 (加權平均)：看懂「市場價值」與「資金流向」
這個指標的計算公式是 

總房屋總價 / 總房屋面積 。它的核心目的是告訴您：


市場資金主要投在哪裡？這個區域或建案的「每坪價值」是多少？

使用時機與分析價值：
評估市場規模與權重：這個數字對「大坪數」或「高總價」的交易更敏感。如果一個區域的加權均價很高，代表市場上的資金主要在追逐高單價、高總價的產品，市場熱度高。

判斷投資趨勢：當您想了解一個區域的整體房地產價值時，加權均價是更好的指標。例如，大型開發商或投資機構在評估一個區域的潛力時，會非常關注這個數字。

宏觀市場比較：在比較不同行政區或不同市場板塊的「含金量」時，加權均價能更準確地反映其市場地位。

簡單來說：這個指標是「投資者視角」，它告訴您市場的錢在哪裡，以及市場的整體價值。

2. 房屋單價分析均價 (算術平均)：了解「普遍行情」與「產品差異」
這個指標的計算公式是 

(A交易單價 + B交易單價 + ... ) / 總交易筆數 。它的核心目的是告訴您：


如果我現在進場交易，最可能遇到的「普遍單價」是多少？

使用時機與分析價值：
掌握普遍成交行情：這個數字剔除了面積大小的影響，更能反映市場上「一般交易」的單價水平。對於想了解「買一間房大概多少錢/坪」的普通購房者或開發商定價參考，這個數字更具參考價值。


精準比較產品類型：在「房屋單價分析」報表中，我們可以精準地比較「住宅」、「店舖」、「事務所」各自的算術平均單價 。因為不同產品的坪數差異很大（店舖通常坪數較大），如果用加權平均，比較結果會失真。用算術平均才能公平地比較不同產品的單價差異。

識別特殊交易：當您發現某個建案的「加權均價」遠高於它的「算術均價」時，這可能暗示該建案有幾筆「超大坪數、超高總價」的特殊戶別（如樓王、頂層特色戶）拉高了整體均價，而大多數戶別的價格其實沒那麼高。

簡單來說：這個指標是「消費者或使用者視角」，它告訴您普遍的交易行情是多少，以及不同產品間的真實價差。

總結比較
特性

核心指標均價 (加權平均)

房屋單價分析均價 (算術平均)

計算基礎

總價 / 總面積

單價加總 / 總筆數

代表意義

市場的「每坪價值」

市場的「平均交易單價」

分析視角

宏觀、投資者視角

微觀、使用者視角

敏感度

對大坪數、高總價的交易敏感

對每一筆交易的權重都相同

主要用途

評估市場規模、資金流向、整體價值

了解普遍行情、比較產品差異、識別個案


Export to Sheets
將兩者分開，是為了提供您一個更立體、更全面的市場圖像。您可以先從「核心指標」了解市場的整體趨勢和價值，再透過「單價分析」深入探究不同產品的具體行情和價量關係，做出更精準的判斷。


Sources





所以你房屋單價分析的圖表「全部」都是算術平均數？



Show thinking
是的，完全正確。

在「房屋單價分析」這個報表頁籤中，所有計算出的「平均單價」全部都是算術平均數。

您可以從後端程式碼 analyze-project-ranking.ts 中得到驗證：


住宅單價統計：此處的平均單價，是將所有符合「住宅大樓」或「華廈」條件的交易 ，把每一筆的「房屋單價(萬)」欄位相加，再除以總筆數得出的 。


除了平均數，此區塊顯示的最低價、最高價、中位數及四分位數，也都是基於對每一筆交易單價進行統計分析的結果 。



建案類型比較：此處比較的「住宅均價」、「店舖均價」、「事務所均價」，同樣是將各分類下的每一筆交易的「房屋單價(萬)」加總後，再除以各自的總筆數所得到的算術平均數 。


這與「核心指標與排名」頁籤中，使用 

總房屋總價 / 總房屋面積 計算出的加權平均數是完全不同的計算邏輯 。



Sources





住宅單價統計 (住宅大樓/華廈) 也是嗎



Show thinking
是的，您說的完全正確。

「住宅單價統計 (住宅大樓/華廈)」這個圖表的平均價也是算術平均數。

根據後端程式碼 analyze-project-ranking.ts 的邏輯，其計算步驟如下：

嚴格篩選：程式會先從所有資料中，只挑選出「建物型態」為「住宅大樓(11層含以上有電梯)」或「華廈(10層含以下有電梯)」的交易。

收集單價：接著，它會收集所有這些被篩選出來的住宅交易中，每一筆各自的「房屋單價(萬)」欄位數值。

計算平均：最後，將所有收集到的單價數值全部加總，再除以總交易筆數，從而得出平均單價。

這個過程 (單價加總 / 總筆數) 正是「算術平均數」的定義。

因此，無論是「住宅單價統計」還是「建案類型比較」，在「房屋單價分析」這個頁籤下的所有均價，都是採用算術平均的計算方式。






建案類型比較 (店舖/事務所 vs. 住宅) 這個也是嗎



Show thinking
是的，完全正確。

「建案類型比較 (店舖/事務所 vs. 住宅)」這個圖表中所有的平均價同樣是算術平均數。

根據後端程式碼 analyze-project-ranking.ts 的分析，其計算邏輯如下：

分類與分組：程式會遍歷所有資料，並根據「建物型態」的關鍵字（如住宅大樓、華廈、店舖、事務所等），將同一建案的交易分到「住宅」、「店舖」、「事務所」等不同的組別中。

分別加總：在每個組別內，程式會將每一筆交易的「房屋單價(萬)」欄位數值進行加總，並計算該組別的總交易筆數。

計算平均值：最後，程式會用各組別的「單價總和」除以該組別的「總筆數」，從而計算出該建案在特定建物類型（住宅、店舖或事務所）的平均單價。

這個計算方式 (各類別的單價總和 / 各類別的總筆數)，正是算術平均數的標準定義。






是因為我要分析單價，所以算術平均數 會比一般均價來的準嗎



Show thinking
非常好的問題，您已經觸及了數據分析的核心！

與其說算術平均數比加權平均數（您稱的「一般均價」）「更準」，不如說它對於「分析單一交易的普遍行情」這個特定目的來說，是**「更適合」或「更具代表性」**的工具。

兩者都是「準確」的，但它們回答的問題完全不同。

當您的目標是「分析單價」時，算術平均數更適合，原因如下：
公平對待每一筆交易：算術平均數將每一筆交易都視為一個獨立的樣本，給予相同的權重。無論是20坪的小宅還是200坪的豪宅，在計算中都只算「一筆」。這能幫助您了解市場上**「普遍一筆交易」的單價**大概落在哪個區間。

避免極端值扭曲行情認知：在房地產市場，有時會出現一兩筆「超大坪數」的交易（例如整層商辦、大地坪店面），它們的單價可能因議價空間大而偏低，或因稀有而極高。

如果使用加權平均（總價/總面積），這筆大坪數交易會對結果產生巨大影響，可能會拉低或拉高整個市場的均價，讓您誤判普遍行情。

而算術平均數因為只把這筆交易當成「一筆」，所以能有效降低這種極端案例的影響，得出的數字更貼近大多數交易的真實情況。

精準比較不同產品：當您想比較「住宅」和「店舖」的單價時，這兩種產品的平均坪數差異很大。使用算術平均數，可以直接比較兩種產品「平均一筆交易」的單價，而不會因為店舖坪數較大而被加權影響，是更公平的比較基準。

那麼，什麼時候「一般均價」（加權平均數）更適合？
當您的分析目標不是單筆交易，而是**整個市場的「總體價值」或「資金熱度」**時，加權平均數就變得非常重要。它能告訴您：

市場的含金量：一個區域的加權均價高，代表市場的資金更集中，整體價值更高。

投資風向：它能反映出高總價、大坪數的產品對市場的影響力，是評估市場結構與投資趨勢的重要指標。

結論
您可以這樣理解：

想知道**「如果我現在去買一間房，大概會是多少錢一坪？」** -> 看算術平均數（房屋單價分析報表）。

想知道**「這個地區的房地產市場，平均每一坪土地上承載了多少價值？」** -> 看加權平均數（核心指標與排名報表）。

因此，不是哪個更「準」的問題，而是您想透過數字看見什麼樣的「事實」。對於分析普遍單價行情，算術平均數確實是更適合、更能反映真實情況的選擇。






那房屋單價的算術平均數跟單價的中位數之間的關西



Show thinking
好的，這是一個非常專業的數據分析問題。了解算術平均數和中位數之間的關係，是判讀房價數據是否健康的關鍵一步。

簡單來說，兩者的關係揭示了房價的 「分佈型態」，能幫助您判斷市場價格是均勻分佈，還是被少數極高或極低的個案所影響。

首先，定義兩者
算術平均數 (Mean)：將所有交易的單價全部加總，再除以總筆數。它像是翹翹板的支點，會被每一筆交易的價格高低所影響，尤其是極端值。

中位數 (Median)：將所有交易的單價從低到高排序，取最中間的那個數字。它代表了市場上「有一半的交易比它便宜，也有一半的交易比它貴」的價格分水嶺。它不受極端價格的影響。

兩者的關係與解讀
在您的分析報表中，這兩個數字的比較可以告訴您以下幾種市場狀況：

情況一：平均數 > 中位數 (最常見)
代表意義：房價分佈呈現 「右偏分佈」 (Right-Skewed)。

市場解讀：這表示市場上存在一些單價**「特別高」**的交易（例如景觀戶、頂樓戶、特殊裝潢的豪宅等）。這些「富貴的鄰居」把整體的平均數往上拉高了，但大多數人的成交價其實沒有那麼貴。

給您的洞察：

中位數更能代表市場的「普遍」或「典型」成交行情。

平均數與中位數的差距越大，表示高價與一般價格的落差越大，市場價格分化越嚴重。

例子：五筆交易單價為 50, 52, 55, 60, 100 (萬/坪)

平均數: (50+52+55+60+100) / 5 = 63.4

中位數: 排序後最中間的是 55

結論: 平均數 (63.4) 被 100 這個高價拉高了，而中位數 (55) 更貼近大多數交易的真實水平。

情況二：平均數 ≈ 中位數
代表意義：房價分佈呈現 「對稱分佈」 (Symmetric)。

市場解讀：這表示市場上的高價和低價交易分佈得相當均勻，沒有太多極端的案例。市場價格相當集中且穩定。

給您的洞察：

在這種情況下，平均數是一個非常可靠的指標，可以很好地代表市場的中心趨勢。

這通常出現在價格穩定、產品同質性高的成熟市場或單一建案中。

情況三：平均數 < 中位數 (較少見)
代表意義：房價分佈呈現 「左偏分佈」 (Left-Skewed)。

市場解讀：這表示市場上存在一些單價**「特別低」**的交易（例如有重大瑕疵、急售、親友交易、地下室或低樓層無採光的戶別）。這些極低價的交易拉低了整體的平均水平。

給您的洞察：

市場上大多數房屋的成交價其實比平均數要高。

需要警惕是否有某些特殊因素或問題物件干擾了市場的整體價格。

總結
在您的「不動產數據查詢平台」中，同時提供平均數與中位數，是一個非常強大的功能 。


先看中位數：快速掌握市場的中心點、典型行情。

再比較平均數：

如果平均數顯著高於中位數，代表市場由高價物件引領，您在看平均價時要保守一些。

如果兩者相近，代表市場健康、穩定，平均價可信度高。

透過這個簡單的比較，您就能一眼看穿數據背後的價格結構，做出比只看單一數字更精準的判斷。


Sources





可是我問的是算術平均數



Show thinking
您說的沒錯，我理解您的問題。

在我上一個回答中，當我提到「平均數」與「中位數」的比較時，我所指的「平均數」，確實就是您所問的「算術平均數」。

讓我更清晰地說明一次：

在「房屋單價分析」這個頁籤中，所有被計算出來的「平均單價」，都是算術平均數。

這份報表同時也計算了中位數。

因此，上一則回覆中關於「平均數 vs. 中位數」的完整分析與比較，整個討論都是圍繞著「算術平均數」與「中位數」這兩個指標的關係來展開的。

我用「平均數」這個詞，是為了口語上方便，但在該情境下，它與「算術平均數」是同義的。

所以，結論是：
將算術平均數與中位數進行比較，可以幫助您判斷房價分佈是否被極端高價或低價的交易影響，進而更深入地理解市場的真實結構。






那如果是 總房價/總坪數 的平均數呢



Show thinking
好的，這是一個更進階的分析角度，我們來探討「總房價/總坪數」的平均數（即加權平均數）與中位數之間的關係。

首先要釐清一個關鍵點：這兩者在計算基礎上是「蘋果與橘子」的比較，但正因如此，它們的差異反而能揭示出非常有價值的市場資訊。

加權平均數 (總房價/總坪數)：這是一個代表市場整體價值的單一結果，它受到「坪數」大小的顯著影響。

中位數：這是將每一筆交易的「房屋單價」 排序後，取出的中間值，它代表的是「一筆典型交易」的單價，不受坪數大小影響。

比較這兩個來自不同計算邏輯的數字，可以幫助我們判斷 「房屋坪數大小」與「房屋單價」之間的關聯性。

關係解讀：坪數大小如何影響單價？
情況一：加權平均數 < 中位數 (最常見)
代表意義：這暗示在該市場中，坪數較大的房屋，其「單位售價」往往較低。

市場解讀：

市場主流為中小坪數產品：市場上可能充斥著單價較高的小坪數住宅（如套房、兩房產品）。因為總價較低，容易入手，所以推高了單位售價。

大坪數產品的「總價控制」：對於大坪數的產品，為了讓「總價」不至於高到無人問津，建商或屋主在「單價」上會做出讓步。這就是所謂的「單價低，但總價高」。

加權效應：因為加權平均數會給予坪數大的交易更高的權重，當這些大坪數產品的單價偏低時，自然會把加權平均數往下拉，使其低於代表普遍行情的中位數。

給您的洞察：這是一個成熟市場的典型特徵。如果您要購買小坪數產品，需要接受較高的單價；若要購買大坪數，則在單價上應有更大的議價空間。

例子：市場上只有兩筆交易

A戶 (小坪數)：20坪，成交單價 100萬/坪 (總價 2,000萬)

B戶 (大坪數)：80坪，成交單價 80萬/坪 (總價 6,400萬)

中位數: (100+80)/2 = 90萬/坪

加權平均數: (2000+6400) / (20+80) = 8400 / 100 = 84萬/坪

結論: 加權平均數 (84) < 中位數 (90)，因為它被單價較低的大坪數B戶往下拉了。

情況二：加權平均數 > 中位數
代表意義：這暗示市場上 坪數較大的房屋，其「單位售價」也較高。

市場解讀：

豪宅市場驅動：這通常發生在以豪宅或特殊產品為主導的市場。這些大坪數的產品因其稀有性、景觀、地段或頂級規劃，不僅總價高，單價也同樣是市場的頂端。

加權效應：這些高單價的大坪數產品在計算加權平均數時，其「高單價」和「大坪數」的雙重優勢會產生極大的影響力，將加權平均數拉高到中位數之上。

給您的洞察：這表示市場的價值主要由金字塔頂端的產品所定義。一般的中小坪數產品與這些指標性豪宅存在明顯的價格斷層。

情況三：加權平均數 ≈ 中位數
代表意義：房屋的「單位售價」與「坪數大小」沒有明顯的相關性。

市場解讀：無論坪數大小，房屋的單價都落在一個相對集中的範圍內。這可能出現在產品規劃非常單一的重劃區，或是所有產品都享有類似條件（如都有景觀、都離捷運站很近）的區域。

給您的洞察：這是一個價格相對單純、同質性高的市場，在做價格判斷時比較不容易被坪數大小誤導。

總結
比較結果

市場現象

核心洞察

加權平均 < 中位數

大坪數產品的單價較低

市場由中小坪數高單價產品主導

加權平均 > 中位數

大坪數產品的單價更高

市場由大坪數豪宅產品定義價值

加權平均 ≈ 中位數

單價與坪數大小無關

市場產品同質性高，價格穩定


Export to Sheets
透過比較這兩個看似無關的數字，您就能巧妙地透視出一個市場**「產品大小」和「產品單價」**之間的深層結構，這對於產品定位、開發策略或購屋選擇都具有極高的參考價值。






我想要在「房屋單價分析」頁面裡面有一個小開關切換算數平均數、加權平均數，另外我希望你上面的邏輯，就是算到平均單價的時候，可以在頁面下面備注 算數平均數跟加權平均數的解釋



Show thinking
好的，這是一個非常好的優化建議，能讓這個分析工具更加靈活與人性化。將您的需求整合到現有的程式架構中是完全可行的。

這需要對後端 (analyze-project-ranking.ts) 和前端 (frontend.rtf) 進行同步修改。以下是詳細的實施步驟與程式碼範例。

第一步：後端修改 (analyze-project-ranking.ts)
目標：讓後端在計算單價分析時，同時算出算術平均數與加權平均數，並在回傳的資料中包含這兩種數值。

1. 修改「住宅單價統計」的計算邏輯
我們需要在 residentialStats 物件中，同時包含兩種平均價。

TypeScript

// 檔案: supabase/functions/analyze-project-ranking/index.ts

// ... 在 4.1 住宅單價統計區塊 ...

let residentialStats = null;
if (sortedResidentialUnitPrices.length > 0) {
    const sumOfUnitPrices = sortedResidentialUnitPrices.reduce((a, b) => a + b, 0);
    
    // 【新增】計算住宅類的總價與總面積，以供加權平均使用
    let residentialTotalPriceSum = 0;
    let residentialTotalAreaSum = 0;
    residentialData.forEach(r => {
        residentialTotalPriceSum += r['房屋總價(萬)'] || 0;
        residentialTotalAreaSum += r['房屋面積(坪)'] || 0;
    });

    // ...
    residentialStats = {
        // 【修改】將 avgPrice 改為一個物件，包含兩種平均數
        avgPrice: {
            arithmetic: safeDivide(sumOfUnitPrices, sortedResidentialUnitPrices.length),
            weighted: safeDivide(residentialTotalPriceSum, residentialTotalAreaSum)
        },
        minPrice: sortedResidentialUnitPrices[0],
        q1Price: calculateQuantile(sortedResidentialUnitPrices, 0.25),
        medianPrice: calculateQuantile(sortedResidentialUnitPrices, 0.5),
        q3Price: calculateQuantile(sortedResidentialUnitPrices, 0.75),
        maxPrice: sortedResidentialUnitPrices[sortedResidentialUnitPrices.length - 1],
        minPriceProject: minPriceRecord['建案名稱'],
        maxPriceProject: maxPriceRecord['建案名稱'],
    };
}
2. 修改「建案類型比較」的計算邏輯
我們需要在 typeComparison 的迴圈中，為每種類型（住宅、店舖、事務所）都計算兩種平均價。

TypeScript

// 檔案: supabase/functions/analyze-project-ranking/index.ts

// ... 在 4.2 建案類型比較區塊 ...

// 首先，修改 Map 的結構，讓它能存放總價與總面積
// ...
if (!typeComparisonGroups.has(projectName)) {
    typeComparisonGroups.set(projectName, {
        '住宅': { prices: [], sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
        '店舖': { prices: [], sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
        '事務所': { prices: [], sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
    });
}
const group = typeComparisonGroups.get(projectName);
if (residentialTypes.includes(buildingType)) {
    group['住宅'].sum += unitPrice;
    group['住宅'].count++;
    group['住宅'].totalPrice += record['房屋總價(萬)'] || 0;
    group['住宅'].totalArea += record['房屋面積(坪)'] || 0;
} else if (buildingType.includes('店舖') || buildingType.includes('店面')) {
    group['店舖'].sum += unitPrice;
    group['店舖'].count++;
    group['店舖'].totalPrice += record['房屋總價(萬)'] || 0;
    group['店舖'].totalArea += record['房屋面積(坪)'] || 0;
} // ... 事務所邏輯相同

// ...

// 然後，在最後的 map 階段，同時計算兩種平均
const typeComparison = Array.from(typeComparisonGroups.entries())
    .map(([projectName, group]) => {
        // 【修改】為每種類型計算兩種平均值
        const residentialAvg = {
            arithmetic: safeDivide(group['住宅'].sum, group['住宅'].count),
            weighted: safeDivide(group['住宅'].totalPrice, group['住宅'].totalArea)
        };
        const shopAvg = {
            arithmetic: safeDivide(group['店舖'].sum, group['店舖'].count),
            weighted: safeDivide(group['店舖'].totalPrice, group['店舖'].totalArea)
        };
        const officeAvg = {
            arithmetic: safeDivide(group['事務所'].sum, group['事務所'].count),
            weighted: safeDivide(group['事務所'].totalPrice, group['事務所'].totalArea)
        };
        
        // 只回傳有住宅均價且至少有一種其他類型的建案
        if (residentialAvg.arithmetic > 0 && (shopAvg.arithmetic > 0 || officeAvg.arithmetic > 0)) {
            return {
                projectName,
                residentialAvg, // 直接回傳物件
                shopAvg,        // 直接回傳物件
                // 計算倍數時，我們通常使用算術平均
                shopMultiple: parseFloat(safeDivide(shopAvg.arithmetic, residentialAvg.arithmetic).toFixed(2)),
                officeAvg,      // 直接回傳物件
                officeMultiple: parseFloat(safeDivide(officeAvg.arithmetic, residentialAvg.arithmetic).toFixed(2)),
            };
        }
        return null;
    }).filter(item => item !== null);
第二步：前端修改 (frontend.rtf)
目標：在「房屋單價分析」頁面加上開關、註解，並根據開關狀態顯示對應的平均數。

1. HTML 結構調整
在 unit-price-report-content 區塊中加入開關，並在最下方加入註解區塊。

HTML

<div id="unit-price-report-content" class="tab-content">
    
    <div class="flex justify-end items-center mb-4">
        <label class="text-sm font-medium text-gray-400 mr-3">平均數類型:</label>
        <div class="inline-flex bg-dark-card p-1 rounded-lg">
            <button data-type="arithmetic" class="avg-type-btn active px-4 py-1 text-sm font-semibold rounded-md transition-colors">算術平均數</button>
            <button data-type="weighted" class="avg-type-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors">加權平均數</button>
        </div>
    </div>

    <div class="mb-8">
        <h3 class="report-section-title">住宅單價統計 (住宅大樓/華廈)</h3>
        <div id="residential-stats-table-container" class="overflow-x-auto"></div>
        <div id="residential-stats-extra-info" class="text-sm text-gray-400 mt-4 space-y-1"></div>
    </div>
    <div>
        <h3 class="report-section-title">建案類型比較 (店舖/事務所 vs. 住宅)</h3>
        <div id="type-comparison-table-container" class="overflow-x-auto"></div>
    </div>

    <div id="average-type-explanation" class="mt-8 p-4 bg-dark-card border border-gray-700 rounded-lg text-sm text-gray-400 space-y-3">
        <h4 class="font-bold text-gray-200">名詞解釋</h4>
        <p><strong class="text-cyan-400">算術平均數 (Arithmetic Mean):</strong> 將每一筆交易的單價直接相加後，除以總筆數。它能反映「一筆典型交易」的單價，不受房屋坪數大小影響，適合了解普遍行情。</p>
        <p><strong class="text-purple-400">加權平均數 (Weighted Average):</strong> 以「總房屋總價 ÷ 總房屋面積」計算。坪數越大的交易，對平均價格的影響力就越大。它更能反映市場的「整體價值」與資金結構。</p>
    </div>
</div>

<style>
    .avg-type-btn { color: #9ca3af; }
    .avg-type-btn.active { background-color: #06b6d4; color: #ffffff; }
</style>
2. JavaScript 邏輯修改
我們需要增加一個狀態來記錄當前選擇的平均數類型，並更新渲染函式。

JavaScript

// 檔案: frontend.rtf (在 <script> 標籤內)

// ... 在 state variables 區域 ...
let currentSort = { key: 'saleAmountSum', order: 'desc' };
let currentAverageType = 'arithmetic'; // 【新增】狀態變數，預設為算術平均

// ... 在 initialize() 函式中，加入事件監聽 ...
function initialize() {
    // ... 其他監聽 ...
    document.querySelector('.avg-type-btn[data-type="arithmetic"]').addEventListener('click', () => switchAverageType('arithmetic'));
    document.querySelector('.avg-type-btn[data-type="weighted"]').addEventListener('click', () => switchAverageType('weighted'));
}

// 【新增】切換平均數的函式
function switchAverageType(type) {
    if (currentAverageType === type) return; // 如果已經是當前類型，則不動作
    currentAverageType = type; // 更新狀態
    
    // 更新按鈕樣式
    document.querySelectorAll('.avg-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });

    // 如果有分析資料快取，就重新渲染單價分析報表
    if (analysisDataCache) {
        renderUnitPriceReport();
    }
}

// 【修改】更新 renderUnitPriceReport 函式，使其能根據狀態顯示不同資料
function renderUnitPriceReport() {
    if (!analysisDataCache || !analysisDataCache.unitPriceAnalysis) return;
    const { residentialStats, typeComparison } = analysisDataCache.unitPriceAnalysis;

    // ... 渲染住宅單價統計表格 ...
    if (residentialStats) {
        // 【修改】從物件中讀取對應的平均價
        const avgPriceToShow = residentialStats.avgPrice[currentAverageType];
        
        statsContainer.innerHTML = `<table class="min-w-full divide-y divide-gray-800">
            <thead><tr><th class="w-1/2">統計項目</th><th class="w-1/2">房屋單價 (萬/坪)</th></tr></thead>
            <tbody>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">平均單價</td><td>${formatNumber(avgPriceToShow)}</td></tr>
                // ... 其他統計項目不變 ...
            </tbody></table>`;
        // ...
    }
    
    // ... 渲染建案類型比較表格 ...
    if (typeComparison && typeComparison.length > 0) {
        // ... 表頭不變 ...
        typeComparison.forEach(item => {
            // 【修改】從物件中讀取對應的平均價
            const residentialAvgToShow = item.residentialAvg[currentAverageType];
            const shopAvgToShow = item.shopAvg[currentAverageType];
            const officeAvgToShow = item.officeAvg[currentAverageType];

            comparisonHtml += `<tr class="hover:bg-dark-card">
                <td>${item.projectName}</td>
                <td>${formatNumber(residentialAvgToShow)}</td>
                <td>${shopAvgToShow > 0 ? formatNumber(shopAvgToShow) : '-'}</td>
                <td>${item.shopMultiple > 0 ? `${formatNumber(item.shopMultiple)} 倍` : '-'}</td>
                <td>${officeAvgToShow > 0 ? formatNumber(officeAvgToShow) : '-'}</td>
                <td>${item.officeMultiple > 0 ? `${formatNumber(item.officeMultiple)} 倍` : '-'}</td>
            </tr>`;
        });
        // ...
    }
}
最終效果
完成以上修改後，您將會得到：

動態切換功能：在「房屋單價分析」頁籤的右上角會出現一個切換按鈕。點擊後，表格中的「平均單價」會立即在算術平均數和加權平均數之間切換，無需重新整理或查詢。

清晰的名詞解釋：在頁面下方，會固定顯示兩種平均數的定義與適用情境，幫助使用者理解數據背後的意義，提升工具的專業性和易用性。







我希望你給我的檔案 我都要完整版（讓我直接剪下、貼上）



Show thinking
好的，沒有問題。

這是在我們詳細討論後，整合了「平均數切換開關」與「名詞解釋」功能的兩個檔案的完整版程式碼。您可以直接複製並貼上，以取代您現有的檔案內容。

1. 後端檔案：supabase/functions/analyze-project-ranking/index.ts
這個版本更新了「房屋單價分析」的邏輯，使其能夠同時計算並回傳算術平均數與加權平均數。

TypeScript

// 檔案路徑: supabase/functions/analyze-project-ranking/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { corsHeaders } from '../_shared/cors.ts';

// --- Helper Functions ---

function calculateQuantile(sortedArr: number[], q: number): number {
  if (!sortedArr.length) return 0;
  const pos = (sortedArr.length - 1) * q;
  const base = Math.floor(pos);
  const rest = pos - base;
  if (sortedArr[base + 1] !== undefined) {
    return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
  } else {
    return sortedArr[base];
  }
}

function safeDivide(numerator: number, denominator: number): number {
  if (denominator === 0 || !denominator) return 0;
  return numerator / denominator;
}

async function fetchAllData(query: any) {
  const allData = [];
  let page = 0;
  const pageSize = 1000;
  let hasMore = true;

  while (hasMore) {
    const { data, error } = await query.range(page * pageSize, (page + 1) * pageSize - 1);
    if (error) throw new Error(`資料庫分頁查詢失敗: ${error.message}`);
    if (data && data.length > 0) {
      allData.push(...data);
      page++;
      if (data.length < pageSize) hasMore = false;
    } else {
      hasMore = false;
    }
  }
  return allData;
}


// --- Main Function ---

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const supabase: SupabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? '',
      { global: { headers: { Authorization: req.headers.get('Authorization')! } } }
    );

    const { filters } = await req.json();
    const { countyCode, district, type, dateStart, dateEnd, projectNames, buildingType } = filters || {};

    if (!countyCode || !type) throw new Error("查詢缺少必要的「縣市代碼」或「交易類型」參數。");
    if (type !== '預售交易' && type !== '中古交易') throw new Error(`此分析功能目前僅支援「預售交易」與「中古交易」。`);

    const typeSuffix = type === '預售交易' ? 'b' : 'a';
    const tableName = `${countyCode.toLowerCase()}_lvr_land_${typeSuffix}`;
    
    const selectColumns = '"建案名稱", "交易總價(萬)", "房屋總價(萬)", "房屋面積(坪)", "房屋單價(萬)", "車位總價(萬)", "車位數", "房數", "衛浴數", "建物型態"';

    let query = supabase.from(tableName).select(selectColumns);

    if (district) query = query.eq('行政區', district);
    if (dateStart) query = query.gte('交易日', dateStart);
    if (dateEnd) query = query.lte('交易日', dateEnd);
    if (buildingType) query = query.eq('建物型態', buildingType);
    if (projectNames && Array.isArray(projectNames) && projectNames.length > 0) {
        query = query.in('建案名稱', projectNames);
    }

    const allRawData = await fetchAllData(query);

    if (!allRawData || allRawData.length === 0) {
      return new Response(JSON.stringify({ coreMetrics: null, projectRanking: [], priceBandAnalysis: [], unitPriceAnalysis: null }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      });
    }

    // --- 1. 計算核心指標 (不變) ---
    let totalSaleAmount = 0, totalHouseArea = 0, totalHousePrice = 0;
    allRawData.forEach(r => {
      totalSaleAmount += r['交易總價(萬)'] || 0;
      totalHouseArea += r['房屋面積(坪)'] || 0;
      totalHousePrice += r['房屋總價(萬)'] || 0;
    });
    const coreMetrics = {
      totalSaleAmount: parseFloat(totalSaleAmount.toFixed(2)),
      totalHouseArea: parseFloat(totalHouseArea.toFixed(2)),
      overallAveragePrice: parseFloat(safeDivide(totalHousePrice, totalHouseArea).toFixed(2)),
      transactionCount: allRawData.length,
    };

    // --- 2. 計算建案排名 (不變) ---
    const projectGroups = new Map<string, any>();
    for (const record of allRawData) { const projectName = record['建案名稱']; if (!projectName) continue; if (!projectGroups.has(projectName)) { projectGroups.set(projectName, { houseAreaSum: 0, transactionCount: 0, saleAmountSum: 0, housePriceSum: 0, parkingPriceSum: 0, parkingCountSum: 0, unitPrices: [], }); } const group = projectGroups.get(projectName); group.houseAreaSum += record['房屋面積(坪)'] || 0; group.transactionCount += 1; group.saleAmountSum += record['交易總價(萬)'] || 0; group.housePriceSum += record['房屋總價(萬)'] || 0; group.parkingPriceSum += record['車位總價(萬)'] || 0; group.parkingCountSum += record['車位數'] || 0; if (typeof record['房屋單價(萬)'] === 'number') { group.unitPrices.push(record['房屋單價(萬)']); } }
    const projectRanking = Array.from(projectGroups.entries()).map(([projectName, group]) => { const sortedUnitPrices = [...group.unitPrices].sort((a,b)=>a-b); return { projectName: projectName, houseAreaSum: parseFloat(group.houseAreaSum.toFixed(2)), transactionCount: group.transactionCount, saleAmountSum: parseFloat(group.saleAmountSum.toFixed(2)), marketShare: parseFloat(safeDivide(group.saleAmountSum, totalSaleAmount) * 100), averagePrice: parseFloat(safeDivide(group.housePriceSum, group.houseAreaSum).toFixed(2)), minPrice: sortedUnitPrices.length > 0 ? sortedUnitPrices[0] : 0, maxPrice: sortedUnitPrices.length > 0 ? sortedUnitPrices[sortedUnitPrices.length - 1] : 0, medianPrice: calculateQuantile(sortedUnitPrices, 0.5), avgParkingPrice: parseFloat(safeDivide(group.parkingPriceSum, group.parkingCountSum).toFixed(2)), }; });

    // --- 3. 計算總價帶分析 (不變) ---
    const layoutGroups = new Map<string, number[]>();
    for (const record of allRawData) { const rooms = record['房數'] || 0; const bathrooms = record['衛浴數'] || 0; const housePrice = record['房屋總價(萬)']; if (typeof housePrice !== 'number' || housePrice <= 0) continue; const layoutKey = `${rooms}房-${bathrooms}衛`; if (!layoutGroups.has(layoutKey)) { layoutGroups.set(layoutKey, []); } layoutGroups.get(layoutKey)!.push(housePrice); }
    const priceBandAnalysis = Array.from(layoutGroups.entries()).map(([layoutKey, prices]) => { const [rooms, bathrooms] = layoutKey.replace('房-', ' ').replace('衛', '').split(' '); const sortedPrices = [...prices].sort((a, b) => a - b); const sum = prices.reduce((a, b) => a + b, 0); return { rooms: parseInt(rooms, 10), bathrooms: parseInt(bathrooms, 10), count: prices.length, avgPrice: parseFloat(safeDivide(sum, prices.length).toFixed(2)), minPrice: sortedPrices[0], q1Price: calculateQuantile(sortedPrices, 0.25), medianPrice: calculateQuantile(sortedPrices, 0.5), q3Price: calculateQuantile(sortedPrices, 0.75), maxPrice: sortedPrices[sortedPrices.length - 1], }; });

    // --- 4. 【修改】計算房屋單價分析 ---
    // 4.1 住宅單價統計
    const residentialTypes = ['住宅大樓(11層含以上有電梯)', '華廈(10層含以下有電梯)'];
    const residentialData = allRawData.filter(r => 
        residentialTypes.includes(r['建物型態']) && typeof r['房屋單價(萬)'] === 'number' && r['房屋單價(萬)'] > 0
    );
    const residentialUnitPrices = residentialData.map(r => r['房屋單價(萬)']);
    const sortedResidentialUnitPrices = [...residentialUnitPrices].sort((a, b) => a - b);
    
    let residentialStats = null;
    if (sortedResidentialUnitPrices.length > 0) {
        const sumOfUnitPrices = sortedResidentialUnitPrices.reduce((a, b) => a + b, 0);
        
        let residentialTotalPriceSum = 0;
        let residentialTotalAreaSum = 0;
        residentialData.forEach(r => {
            residentialTotalPriceSum += r['房屋總價(萬)'] || 0;
            residentialTotalAreaSum += r['房屋面積(坪)'] || 0;
        });

        const minPriceRecord = residentialData.reduce((prev, curr) => (prev['房屋單價(萬)'] < curr['房屋單價(萬)']) ? prev : curr);
        const maxPriceRecord = residentialData.reduce((prev, curr) => (prev['房屋單價(萬)'] > curr['房屋單價(萬)']) ? prev : curr);
        
        residentialStats = {
            avgPrice: {
                arithmetic: safeDivide(sumOfUnitPrices, sortedResidentialUnitPrices.length),
                weighted: safeDivide(residentialTotalPriceSum, residentialTotalAreaSum)
            },
            minPrice: sortedResidentialUnitPrices[0],
            q1Price: calculateQuantile(sortedResidentialUnitPrices, 0.25),
            medianPrice: calculateQuantile(sortedResidentialUnitPrices, 0.5),
            q3Price: calculateQuantile(sortedResidentialUnitPrices, 0.75),
            maxPrice: sortedResidentialUnitPrices[sortedResidentialUnitPrices.length - 1],
            minPriceProject: minPriceRecord['建案名稱'],
            maxPriceProject: maxPriceRecord['建案名稱'],
        };
    }

    // 4.2 建案類型比較
    const typeComparisonGroups = new Map<string, any>();
    for (const record of allRawData) {
        const projectName = record['建案名稱'];
        const buildingType = record['建物型態'];
        const unitPrice = record['房屋單價(萬)'];
        if (!projectName || typeof unitPrice !== 'number' || unitPrice <= 0) continue;

        if (!typeComparisonGroups.has(projectName)) {
            typeComparisonGroups.set(projectName, {
                '住宅': { sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
                '店舖': { sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
                '事務所': { sum: 0, count: 0, totalPrice: 0, totalArea: 0 },
            });
        }
        const group = typeComparisonGroups.get(projectName);
        if (residentialTypes.includes(buildingType)) {
            group['住宅'].sum += unitPrice;
            group['住宅'].count++;
            group['住宅'].totalPrice += record['房屋總價(萬)'] || 0;
            group['住宅'].totalArea += record['房屋面積(坪)'] || 0;
        } else if (buildingType.includes('店舖') || buildingType.includes('店面')) {
            group['店舖'].sum += unitPrice;
            group['店舖'].count++;
            group['店舖'].totalPrice += record['房屋總價(萬)'] || 0;
            group['店舖'].totalArea += record['房屋面積(坪)'] || 0;
        } else if (buildingType.includes('辦公') || buildingType.includes('事務所')) {
            group['事務所'].sum += unitPrice;
            group['事務所'].count++;
            group['事務所'].totalPrice += record['房屋總價(萬)'] || 0;
            group['事務所'].totalArea += record['房屋面積(坪)'] || 0;
        }
    }

    const typeComparison = Array.from(typeComparisonGroups.entries())
        .map(([projectName, group]) => {
            const residentialAvg = {
                arithmetic: safeDivide(group['住宅'].sum, group['住宅'].count),
                weighted: safeDivide(group['住宅'].totalPrice, group['住宅'].totalArea)
            };
            const shopAvg = {
                arithmetic: safeDivide(group['店舖'].sum, group['店舖'].count),
                weighted: safeDivide(group['店舖'].totalPrice, group['店舖'].totalArea)
            };
            const officeAvg = {
                arithmetic: safeDivide(group['事務所'].sum, group['事務所'].count),
                weighted: safeDivide(group['事務所'].totalPrice, group['事務所'].totalArea)
            };

            if (residentialAvg.arithmetic > 0 && (shopAvg.arithmetic > 0 || officeAvg.arithmetic > 0)) {
                return {
                    projectName,
                    residentialAvg,
                    shopAvg,
                    shopMultiple: parseFloat(safeDivide(shopAvg.arithmetic, residentialAvg.arithmetic).toFixed(2)),
                    officeAvg,
                    officeMultiple: parseFloat(safeDivide(officeAvg.arithmetic, residentialAvg.arithmetic).toFixed(2)),
                };
            }
            return null;
        }).filter(item => item !== null);

    const unitPriceAnalysis = {
        residentialStats,
        typeComparison,
    };

    // --- 5. 回傳所有分析結果 ---
    return new Response(
      JSON.stringify({ coreMetrics, projectRanking, priceBandAnalysis, unitPriceAnalysis }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (err) {
    console.error('【分析功能】處理過程發生錯誤:', err);
    return new Response(JSON.stringify({ error: err.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 400,
    });
  }
});
2. 前端檔案：frontend.rtf
這個版本加入了平均數切換開關、名詞解釋區塊，並更新了 JavaScript 邏輯來處理新的資料格式與互動功能。

HTML

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>不動產數據查詢平台</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-bg': '#1a1d29',
        'dark-card': '#252836',
        'cyan-accent': '#06b6d4',
        'purple-accent': '#8b5cf6',
      }
    }
  }
}
</script>
<style>
body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background: #1a1d29; color: #e5e7eb; }
.glass-card { background: rgba(37, 40, 54, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
.form-input, .form-select { background-color: #1f2937; border: 1px solid #4b5563; color: #d1d5db; }
.form-input:focus, .form-select:focus, .form-input:has(input:focus) { border-color: #06b6d4; box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.5); outline: none; }
select:disabled, input:disabled { background-color: #374151; cursor: not-allowed; opacity: 0.7; }
.table-container { overflow-y: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { border-bottom: 1px solid #374151; padding: 0.75rem 1rem; text-align: left; font-size: 0.875rem; white-space: nowrap; }
thead th { background-color: #252836; position: sticky; top: 0; z-index: 10; font-weight: 600; color: #9ca3af; }
.loader { border: 4px solid #374151; border-top: 4px solid #06b6d4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
.modal-container { background: #252836; padding: 2rem; border-radius: 12px; width: 90%; max-width: 1200px; max-height: 85vh; overflow-y: auto; border: 1px solid #4b5563; transform: scale(0.95); transition: transform 0.3s ease; }
.modal-overlay:not(.hidden) .modal-container { transform: scale(1); }
.project-tag { display: inline-flex; align-items: center; background-color: #4b5563; color: #d1d5db; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; flex-shrink: 0; }
.project-tag-remove { margin-left: 0.5rem; cursor: pointer; font-weight: bold; }
.project-tag-remove:hover { color: #f87171; }
#project-name-suggestions { max-height: 200px; overflow-y: auto; }
.suggestion-item { display: flex; align-items: center; padding: 0.5rem 1rem; cursor: pointer; }
.suggestion-item:hover, .suggestion-item.active { background-color: #374151; }
.suggestion-item input[type="checkbox"] { margin-right: 0.75rem; height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #6b7280; background-color: #374151; color: #06b6d4; cursor: pointer; }
.suggestion-item input[type="checkbox"]:focus { ring: #06b6d4; }
.scrollable-cell { max-width: 25ch; overflow-x: auto; white-space: nowrap; padding-top: 4px; padding-bottom: 4px; }
.scrollable-cell::-webkit-scrollbar, #project-name-container::-webkit-scrollbar { height: 4px; }
.scrollable-cell::-webkit-scrollbar-track, #project-name-container::-webkit-scrollbar-track { background: transparent; }
.scrollable-cell::-webkit-scrollbar-thumb, #project-name-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
.tab-button { padding: 0.75rem 1.5rem; font-medium; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #9ca3af; }
.tab-button.active { color: #06b6d4; border-bottom-color: #06b6d4; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.metric-card { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #374151; }
.metric-card-title { font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem; }
.metric-card-value { font-size: 2rem; font-weight: 700; color: #e5e7eb; }
.metric-card-unit { font-size: 1rem; color: #6b7280; margin-left: 0.5rem; }
.sortable-th { cursor: pointer; user-select: none; }
.sortable-th:hover { color: #e5e7eb; }
.sortable-th .sort-icon { display: inline-block; margin-left: 0.5rem; color: #6b7280; transition: all 0.2s; }
.sortable-th.asc .sort-icon { transform: rotate(180deg); color: #06b6d4; }
.sortable-th.desc .sort-icon { color: #06b6d4; }
.report-section-title { font-size: 1.25rem; font-weight: 600; color: #e5e7eb; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #374151;}
.avg-type-btn { color: #9ca3af; }
.avg-type-btn.active { background-color: #06b6d4; color: #ffffff; }
</style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-screen-2xl mx-auto">
  <header class="mb-8 text-center">
    <h1 class="text-4xl font-extrabold text-white tracking-tight">不動產數據查詢平台</h1>
    <p class="mt-2 text-lg text-gray-400">您的專屬數據查詢與分析工具。</p>
  </header>

  <main>
    <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
      <div id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 items-end">
        <div><label for="county" class="block text-sm font-medium text-gray-300">縣市</label><select id="county" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md"><option value="">請選擇縣市</option></select></div>
        <div><label for="district" class="block text-sm font-medium text-gray-300">行政區</label><select id="district" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md" disabled><option value="">請先選縣市</option></select></div>
        <div><label for="type" class="block text-sm font-medium text-gray-300">交易類型</label><select id="type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md"><option value="預售交易" selected>預售交易</option><option value="中古交易">中古交易</option><option value="租賃交易" disabled>租賃交易 (開發中)</option></select></div>
        <div><label for="building-type" class="block text-sm font-medium text-gray-300">建物型態</label><select id="building-type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md"><option value="">全部</option><option value="住宅大樓(11層含以上有電梯)">住宅大樓</option><option value="華廈(10層含以下有電梯)">華廈</option><option value="公寓(5層含以下無電梯)">公寓</option><option value="套房(1房(1廳)1衛)">套房</option><option value="透天厝">透天厝</option><option value="店面(店鋪)">店面</option><option value="辦公商業大樓">辦公商業大樓</option><option value="工廠">工廠</option><option value="倉庫">倉庫</option><option value="其他">其他</option></select></div>
        <div class="xl:col-span-2"><div class="flex justify-between items-center"><label for="project-name-input" class="block text-sm font-medium text-gray-300">建案名稱 (可複選)</label><button id="clear-projects-btn" class="text-xs text-cyan-400 hover:text-cyan-300 hidden transition-opacity">清除選取</button></div><div class="relative mt-1"><div id="project-name-container" class="form-input flex flex-nowrap items-center gap-2 p-1 min-h-[42px] rounded-md overflow-x-auto"><input type="text" id="project-name-input" placeholder="請先選縣市..." class="bg-transparent flex-grow outline-none text-base py-1 px-2" disabled></div><div id="project-name-suggestions" class="absolute z-20 w-full mt-1 bg-dark-card border border-gray-600 rounded-md shadow-lg hidden"></div></div></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:col-span-2 lg:col-span-4 xl:col-span-4">
            <div>
                <label for="date-range" class="block text-sm font-medium text-gray-300">快捷時間</label>
                <select id="date-range" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                    <option value="custom">自訂範圍</option><option value="7d">近7天</option><option value="14d">近14天</option><option value="30d">近30天</option><option value="1q">近一季 (3個月)</option><option value="2q">近兩季 (6個月)</option><option value="3q">近三季 (9個月)</option><option value="1y">近一年 (12個月)</option><option value="this_year">今年以來</option><option value="last_2_years">去年＋今年</option><option value="last_3_years">前年＋去年＋今年</option>
                </select>
            </div>
            <div><label for="date-start" class="block text-sm font-medium text-gray-300">起始日期</label><input type="date" id="date-start" class="form-input mt-1 block w-full pl-3 pr-2 py-2 text-base rounded-md"></div>
            <div><label for="date-end" class="block text-sm font-medium text-gray-300">結束日期</label><input type="date" id="date-end" class="form-input mt-1 block w-full pl-3 pr-2 py-2 text-base rounded-md"></div>
        </div>
        <div class="sm:col-span-2 lg:col-span-4 xl:col-span-6 flex justify-end items-center gap-4">
          <button id="analyze-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">分析報表</button>
          <button id="search-btn" class="bg-gradient-to-r from-cyan-accent to-purple-accent text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all">查詢資料列表</button>
        </div>
      </div>
    </div>
    
    <div id="results-container" class="glass-card p-6 rounded-xl shadow-lg">
      <div id="tabs-container" class="border-b border-gray-700 mb-6 hidden">
        <nav class="flex -mb-px">
          <button data-tab="ranking-report" class="tab-button active">核心指標與排名</button>
          <button data-tab="price-band-report" class="tab-button">總價帶分析</button>
          <button data-tab="unit-price-report" class="tab-button">房屋單價分析</button>
          <button data-tab="data-list" class="tab-button">資料列表</button>
        </nav>
      </div>

      <div id="message-area" class="text-center p-8 text-gray-400">請設定篩選條件後點擊查詢或分析。</div>

      <div id="ranking-report-content" class="tab-content"><div id="metric-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-8"></div><div class="overflow-x-auto"><table id="ranking-table" class="min-w-full divide-y divide-gray-800"></table></div></div>
      
      <div id="price-band-report-content" class="tab-content"><div class="overflow-x-auto"><table id="price-band-table" class="min-w-full divide-y divide-gray-800"></table></div></div>

      <div id="unit-price-report-content" class="tab-content">
        
        <div class="flex justify-end items-center mb-4">
            <label class="text-sm font-medium text-gray-400 mr-3">平均數類型:</label>
            <div class="inline-flex bg-dark-card p-1 rounded-lg">
                <button data-type="arithmetic" class="avg-type-btn active px-4 py-1 text-sm font-semibold rounded-md transition-colors">算術平均數</button>
                <button data-type="weighted" class="avg-type-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors">加權平均數</button>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="report-section-title">住宅單價統計 (住宅大樓/華廈)</h3>
            <div id="residential-stats-table-container" class="overflow-x-auto"></div>
            <div id="residential-stats-extra-info" class="text-sm text-gray-400 mt-4 space-y-1"></div>
        </div>
        <div>
            <h3 class="report-section-title">建案類型比較 (店舖/事務所 vs. 住宅)</h3>
            <div id="type-comparison-table-container" class="overflow-x-auto"></div>
        </div>
        
        <div id="average-type-explanation" class="mt-8 p-4 bg-dark-card border border-gray-700 rounded-lg text-sm text-gray-400 space-y-3">
            <h4 class="font-bold text-gray-200">名詞解釋</h4>
            <p><strong class="text-cyan-400">算術平均數 (Arithmetic Mean):</strong> 將每一筆交易的單價直接相加後，除以總筆數。它能反映「一筆典型交易」的單價，不受房屋坪數大小影響，適合了解普遍行情。</p>
            <p><strong class="text-purple-400">加權平均數 (Weighted Average):</strong> 以「總房屋總價 ÷ 總房屋面積」計算。坪數越大的交易，對平均價格的影響力就越大。它更能反映市場的「整體價值」與資金結構。</p>
        </div>
      </div>

      <div id="data-list-content" class="tab-content"><div id="table-container" class="table-container overflow-x-auto"><table id="results-table" class="min-w-full divide-y divide-gray-800"></table></div><div id="pagination-controls" class="flex justify-between items-center mt-4 text-sm text-gray-400"></div></div>
    </div>
  </main>
</div>

<div id="details-modal" class="modal-overlay hidden"><div class="modal-container"><div class="flex justify-between items-center mb-6"><h2 id="modal-title" class="text-2xl font-bold text-white">附表詳細資料</h2><button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button></div><div id="modal-content" class="text-gray-300"></div></div></div>

<script type="module">
// API Endpoints
const EDGE_FUNCTION_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-data';
const SUB_DATA_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-sub-data';
const PROJECT_NAMES_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-names';
const RANKING_ANALYSIS_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/analyze-project-ranking';
// DOM Elements
const dom = {
  countySelect: document.getElementById('county'),
  districtSelect: document.getElementById('district'),
  typeSelect: document.getElementById('type'),
  buildingTypeSelect: document.getElementById('building-type'),
  dateRangeSelect: document.getElementById('date-range'),
  dateStartInput: document.getElementById('date-start'),
  dateEndInput: document.getElementById('date-end'),
  searchBtn: document.getElementById('search-btn'),
  analyzeBtn: document.getElementById('analyze-btn'),
  messageArea: document.getElementById('message-area'),
  tabsContainer: document.getElementById('tabs-container'),
  // 報表
  rankingReportContent: document.getElementById('ranking-report-content'),
  metricCardsContainer: document.getElementById('metric-cards-container'),
  rankingTable: document.getElementById('ranking-table'),
  priceBandReportContent: document.getElementById('price-band-report-content'),
  priceBandTable: document.getElementById('price-band-table'),
  unitPriceReportContent: document.getElementById('unit-price-report-content'),
  residentialStatsTableContainer: document.getElementById('residential-stats-table-container'),
  residentialStatsExtraInfo: document.getElementById('residential-stats-extra-info'),
  typeComparisonTableContainer: document.getElementById('type-comparison-table-container'),
  // 資料列表
  dataListContent: document.getElementById('data-list-content'),
  resultsTable: document.getElementById('results-table'),
  paginationControls: document.getElementById('pagination-controls'),
  // Modal
  modal: document.getElementById('details-modal'),
  modalTitle: document.getElementById('modal-title'),
  modalContent: document.getElementById('modal-content'),
  modalCloseBtn: document.getElementById('modal-close-btn'),
  // 建案複選
  projectNameContainer: document.getElementById('project-name-container'),
  projectNameInput: document.getElementById('project-name-input'),
  projectNameSuggestions: document.getElementById('project-name-suggestions'),
  clearProjectsBtn: document.getElementById('clear-projects-btn'),
};
// State variables
let currentPage = 1, pageSize = 30, totalRecords = 0;
let selectedProjects = [], suggestionDebounceTimer;
let analysisDataCache = null;
let currentSort = { key: 'saleAmountSum', order: 'desc' };
let currentAverageType = 'arithmetic'; // 新增狀態變數

// Data
const districtData = {"臺北市":["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],"新北市":["板橋區","三重區","中和區","永和區","新莊區","新店區","樹林區","鶯歌區","三峽區","淡水區","汐止區","瑞芳區","土城區","蘆洲區","五股區","泰山區","林口區","深坑區","石碇區","坪林區","三芝區","石門區","八里區","平溪區","雙溪區","貢寮區","金山區","萬里區","烏來區"],"桃園市":["桃園區","中壢區","大溪區","楊梅區","蘆竹區","大園區","龜山區","八德區","龍潭區","平鎮區","新屋區","觀音區","復興區"],"臺中市":["中區","東區","南區","西區","北區","北屯區","西屯區","南屯區","太平區","大里區","霧峰區","烏日區","豐原區","后里區","石岡區","東勢區","和平區","新社區","潭子區","大雅區","神岡區","大肚區","沙鹿區","龍井區","梧棲區","清水區","大甲區","外埔區","大安區"],"臺南市":["中西區","東區","南區","北區","安平區","安南區","永康區","歸仁區","新化區","左鎮區","玉井區","楠西區","南化區","仁德區","關廟區","龍崎區","官田區","麻豆區","佳里區","西港區","七股區","將軍區","學甲區","北門區","新營區","後壁區","白河區","東山區","六甲區","下營區","柳營區","鹽水區","善化區","大內區","山上區","新市區","安定區"],"高雄市":["新興區","前金區","苓雅區","鹽埕區","鼓山區","旗津區","前鎮區","三民區","楠梓區","小港區","左營區","仁武區","大社區","岡山區","路竹區","阿蓮區","田寮區","燕巢區","橋頭區","梓官區","彌陀區","永安區","湖內區","鳳山區","大寮區","林園區","鳥松區","大樹區","旗山區","美濃區","六龜區","內門區","杉林區","甲仙區","桃源區","那瑪夏區","茂林區","茄萣區"],"基隆市":["仁愛區","信義區","中正區","中山區","安樂區","暖暖區","七堵區"],"新竹市":["東區","北區","香山區"],"嘉義市":["東區","西區"],"宜蘭縣":["宜蘭市","羅東鎮","蘇澳鎮","頭城鎮","礁溪鄉","壯圍鄉","員山鄉","冬山鄉","五結鄉","三星鄉","大同鄉","南澳鄉"],"新竹縣":["竹北市","竹東鎮","新埔鎮","關西鎮","湖口鄉","新豐鄉","芎林鄉","橫山鄉","北埔鄉","寶山鄉","峨眉鄉","尖石鄉","五峰鄉"],"苗栗縣":["苗栗市","苑裡鎮","通霄鎮","竹南鎮","頭份鎮","後龍鎮","卓蘭鎮","大湖鄉","公館鄉","銅鑼鄉","南庄鄉","頭屋鄉","三義鄉","西湖鄉","造橋鄉","三灣鄉","獅潭鄉","泰安鄉"],"彰化縣":["彰化市","鹿港鎮","和美鎮","線西鄉","伸港鄉","福興鄉","秀水鄉","花壇鄉","芬園鄉","員林鎮","溪湖鎮","田中鎮","大村鄉","埔鹽鄉","埔心鄉","永靖鄉","社頭鄉","二水鄉","北斗鎮","二林鎮","田尾鄉","埤頭鄉","芳苑鄉","大城鄉","竹塘鄉","溪州鄉"],"南投縣":["南投市","埔里鎮","草屯鎮","竹山鎮","集集鎮","名間鄉","鹿谷鄉","中寮鄉","魚池鄉","國姓鄉","水里鄉","信義鄉","仁愛鄉"],"雲林縣":["斗六市","斗南鎮","虎尾鎮","西螺鎮","土庫鎮","北港鎮","古坑鄉","大埤鄉","莿桐鄉","林內鄉","二崙鄉","崙背鄉","麥寮鄉","東勢鄉","褒忠鄉","台西鄉","元長鄉","四湖鄉","口湖鄉","水林鄉"],"嘉義縣":["太保市","朴子市","布袋鎮","大林鎮","民雄鄉","溪口鄉","新港鄉","六腳鄉","東石鄉","義竹鄉","鹿草鄉","水上鄉","中埔鄉","竹崎鄉","梅山鄉","番路鄉","大埔鄉","阿里山鄉"],"屏東縣":["屏東市","潮州鎮","東港鎮","恆春鎮","萬丹鄉","長治鄉","麟洛鄉","九如鄉","里港鄉","鹽埔鄉","高樹鄉","萬巒鄉","內埔鄉","竹田鄉","新埤鄉","枋寮鄉","新園鄉","崁頂鄉","林邊鄉","南州鄉","佳冬鄉","琉球鄉","車城鄉","滿州鄉","枋山鄉","霧台鄉","瑪家鄉","泰武鄉","來義鄉","春日鄉","獅子鄉","牡丹鄉","三地門鄉"],"花蓮縣":["花蓮市","鳳林鎮","玉里鎮","新城鄉","吉安鄉","壽豐鄉","光復鄉","豐濱鄉","瑞穗鄉","富里鄉","秀林鄉","萬榮鄉","卓溪鄉"],"臺東縣":["臺東市","成功鎮","關山鎮","卑南鄉","鹿野鄉","池上鄉","東河鄉","長濱鄉","太麻里鄉","大武鄉","綠島鄉","海端鄉","延平鄉","金峰鄉","達仁鄉","蘭嶼鄉"],"澎-湖縣":["馬公市","湖西鄉","白沙鄉","西嶼鄉","望安鄉","七美鄉"],"金門縣":["金城鎮","金湖鎮","金沙鎮","金寧鄉","烈嶼鄉","烏坵鄉"],"連江縣":["南竿鄉","北竿鄉","莒光鄉","東引鄉"]};
const countyCodeMap = { "臺北市": "A", "新北市": "F", "桃園市": "H", "臺中市": "B", "臺南市": "D", "高雄市": "E", "基隆市": "C", "新竹市": "O", "嘉義市": "I", "新竹縣": "J", "苗栗縣": "K", "彰化縣": "N", "南投縣": "M", "雲林縣": "P", "嘉義縣": "Q", "屏東縣": "T", "宜蘭縣": "G", "花蓮縣": "U", "臺東縣": "V", "澎湖縣": "X", "金門縣": "W", "連江縣": "Z" };
// --- Event Listeners & Initializers ---
function initialize() {
  Object.keys(districtData).forEach(name => dom.countySelect.add(new Option(name, name)));
  dom.searchBtn.addEventListener('click', () => { currentPage = 1; fetchData(); });
  dom.analyzeBtn.addEventListener('click', analyzeData);
  dom.countySelect.addEventListener('change', updateDistrictOptions);
  dom.typeSelect.addEventListener('change', toggleAnalyzeButtonState);
  dom.dateRangeSelect.addEventListener('change', handleDateRangeChange);
  dom.dateStartInput.addEventListener('input', () => { if (document.activeElement === dom.dateStartInput) dom.dateRangeSelect.value = 'custom'; });
  dom.dateEndInput.addEventListener('input', () => { if (document.activeElement === dom.dateEndInput) dom.dateRangeSelect.value = 'custom'; });
  dom.modalCloseBtn.addEventListener('click', () => dom.modal.classList.add('hidden'));
  dom.resultsTable.addEventListener('click', e => { if (e.target.closest('.details-btn')) showSubTableDetails(e.target.closest('.details-btn')); });
  dom.projectNameInput.addEventListener('input', onProjectInput);
  dom.projectNameSuggestions.addEventListener('click', onSuggestionClick);
  dom.projectNameContainer.addEventListener('click', onTagRemove);
  document.addEventListener('click', e => { if (!dom.projectNameContainer.parentElement.contains(e.target)) dom.projectNameSuggestions.classList.add('hidden'); });
  dom.clearProjectsBtn.addEventListener('click', clearSelectedProjects);
  dom.tabsContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) switchTab(e.target.dataset.tab); });
  dom.rankingTable.addEventListener('click', e => {
    const header = e.target.closest('.sortable-th');
    if (!header) return;
    const sortKey = header.dataset.sortKey;
    if (currentSort.key === sortKey) {
      currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
    } else {
      currentSort.key = sortKey;
      currentSort.order = 'desc';
    }
    renderRankingReport();
  });

  // 新增開關的事件監聽
  document.querySelector('.avg-type-btn[data-type="arithmetic"]').addEventListener('click', () => switchAverageType('arithmetic'));
  document.querySelector('.avg-type-btn[data-type="weighted"]').addEventListener('click', () => switchAverageType('weighted'));

  toggleAnalyzeButtonState();
}

// --- 新增: 切換平均數的函式 ---
function switchAverageType(type) {
    if (currentAverageType === type) return;
    currentAverageType = type;
    
    document.querySelectorAll('.avg-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });

    if (analysisDataCache) {
        renderUnitPriceReport();
    }
}

// --- UI & State Management ---
function switchTab(targetTab) {
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
  document.getElementById(`${targetTab}-content`).classList.add('active');
  document.querySelector(`button[data-tab="${targetTab}"]`).classList.add('active');
}

function getFilters() {
    const filters = {};
    if (dom.countySelect.value) filters.countyCode = countyCodeMap[dom.countySelect.value] || '';
    if (dom.districtSelect.value) filters.district = dom.districtSelect.value;
    if (dom.typeSelect.value) filters.type = dom.typeSelect.value;
    if (dom.dateStartInput.value) filters.dateStart = dom.dateStartInput.value;
    if (dom.dateEndInput.value) filters.dateEnd = dom.dateEndInput.value;
    if (dom.buildingTypeSelect.value) filters.buildingType = dom.buildingTypeSelect.value;
    if (selectedProjects.length > 0) filters.projectNames = selectedProjects;
    return filters;
}

function showLoading(message) {
    dom.messageArea.innerHTML = `<div class="loader mx-auto"></div><p class="mt-4">${message}</p>`;
    dom.messageArea.classList.remove('hidden');
    dom.tabsContainer.classList.add('hidden');
    ['ranking-report-content', 'price-band-report-content', 'unit-price-report-content', 'data-list-content'].forEach(id => document.getElementById(id).classList.remove('active'));
}

function showMessage(message, isError = false) {
    const messageClass = isError ? 'bg-red-900/50 border border-red-700 text-red-200 p-4 rounded-lg' : '';
    dom.messageArea.innerHTML = `<div class="${messageClass}">${message}</div>`;
    dom.messageArea.classList.remove('hidden');
    dom.tabsContainer.classList.add('hidden');
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function handleDateRangeChange() {
    const value = dom.dateRangeSelect.value;
    if (value === 'custom') return;
    const endDate = new Date();
    let startDate = new Date();
    switch (value) {
        case '7d': startDate.setDate(endDate.getDate() - 7); break;
        case '14d': startDate.setDate(endDate.getDate() - 14); break;
        case '30d': startDate.setDate(endDate.getDate() - 30); break;
        case '1q': startDate.setMonth(endDate.getMonth() - 3); break;
        case '2q': startDate.setMonth(endDate.getMonth() - 6); break;
        case '3q': startDate.setMonth(endDate.getMonth() - 9); break;
        case '1y': startDate.setFullYear(endDate.getFullYear() - 1); break;
        case 'this_year': startDate = new Date(endDate.getFullYear(), 0, 1); break;
        case 'last_2_years': startDate = new Date(endDate.getFullYear() - 1, 0, 1); break;
        case 'last_3_years': startDate = new Date(endDate.getFullYear() - 2, 0, 1); break;
    }
    dom.dateStartInput.value = formatDate(startDate);
    dom.dateEndInput.value = formatDate(endDate);
}

// --- Data Fetching & Analysis ---
async function analyzeData() {
  if (!dom.countySelect.value) return showMessage('請先選擇一個縣市再進行分析。');
  showLoading('分析中，請稍候...');
  try {
    const response = await fetch(RANKING_ANALYSIS_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M' },
      body: JSON.stringify({ filters: getFilters() })
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({ error: `分析請求失敗: ${response.status}` }));
      throw new Error(err.error);
    }
    analysisDataCache = await response.json();
    if (!analysisDataCache.coreMetrics) return showMessage('找不到符合條件的分析資料。');
    
    dom.messageArea.classList.add('hidden');
    dom.tabsContainer.classList.remove('hidden');
    currentSort = { key: 'saleAmountSum', order: 'desc' };
    
    renderRankingReport();
    renderPriceBandReport();
    renderUnitPriceReport();
    
    switchTab('ranking-report');
  } catch(error) {
    console.error("數據分析失敗:", error);
    showMessage(`數據分析失敗: ${error.message}`, true);
    analysisDataCache = null;
  }
}

async function fetchData() {
  showLoading('查詢中，請稍候...');
  try {
    const response = await fetch(EDGE_FUNCTION_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M' },
      body: JSON.stringify({ filters: getFilters(), pagination: { page: currentPage, limit: pageSize } })
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({ error: '無法解析伺服器回應' }));
      throw new Error(err.error);
    }
    const result = await response.json();
    totalRecords = result.count || 0;
    if (!result.data || result.data.length === 0) {
      showMessage('找不到符合條件的資料。');
      renderPagination();
      return;
    }
    renderTable(result.data);
    renderPagination();
    dom.messageArea.classList.add('hidden');
    dom.tabsContainer.classList.remove('hidden');
    switchTab('data-list');
  } catch (error) {
    console.error('查詢錯誤:', error);
    showMessage(`查詢錯誤: ${error.message}`, true);
    totalRecords = 0;
    renderPagination();
  }
}

// --- Rendering Functions ---
function formatNumber(num, decimals = 2) {
    if (typeof num !== 'number' || isNaN(num)) return '-';
    return num.toLocaleString('zh-TW', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

function renderRankingReport() {
    if (!analysisDataCache || !analysisDataCache.coreMetrics) return;
    const { coreMetrics, projectRanking } = analysisDataCache;
    dom.metricCardsContainer.innerHTML = `
        <div class="metric-card"><div class="metric-card-title">市場去化總銷售金額</div><div><span class="metric-card-value">${formatNumber(coreMetrics.totalSaleAmount, 0)}</span><span class="metric-card-unit">萬</span></div></div>
        <div class="metric-card"><div class="metric-card-title">總銷去化房屋坪數</div><div><span class="metric-card-value">${formatNumber(coreMetrics.totalHouseArea, 2)}</span><span class="metric-card-unit">坪</span></div></div>
        <div class="metric-card"><div class="metric-card-title">總平均單價</div><div><span class="metric-card-value">${formatNumber(coreMetrics.overallAveragePrice, 2)}</span><span class="metric-card-unit">萬/坪</span></div></div>
        <div class="metric-card"><div class="metric-card-title">總交易筆數</div><div><span class="metric-card-value">${coreMetrics.transactionCount.toLocaleString()}</span><span class="metric-card-unit">筆</span></div></div>
    `;
    projectRanking.sort((a, b) => {
        const valA = a[currentSort.key];
        const valB = b[currentSort.key];
        return currentSort.order === 'desc' ? valB - valA : valA - valB;
    });
    const tableHeaders = [{ key: 'rank', label: '排名', sortable: false },{ key: 'projectName', label: '建案名稱', sortable: false },{ key: 'saleAmountSum', label: '交易總價(萬)', sortable: true },{ key: 'houseAreaSum', label: '房屋面積(坪)', sortable: true },{ key: 'transactionCount', label: '資料筆數', sortable: true },{ key: 'marketShare', label: '市場佔比(%)', sortable: true },{ key: 'averagePrice', label: '平均單價(萬)', sortable: true },{ key: 'minPrice', label: '最低單價(萬)', sortable: true },{ key: 'maxPrice', label: '最高單價(萬)', sortable: true },{ key: 'medianPrice', label: '單價中位數(萬)', sortable: true },{ key: 'avgParkingPrice', label: '車位平均單價', sortable: true }];
    let headerHtml = '<thead><tr>';
    tableHeaders.forEach(h => {
        if (h.sortable) {
            const sortClass = currentSort.key === h.key ? currentSort.order : '';
            headerHtml += `<th class="sortable-th ${sortClass}" data-sort-key="${h.key}">${h.label}<span class="sort-icon">▼</span></th>`;
        } else { headerHtml += `<th>${h.label}</th>`; }
    });
    headerHtml += '</tr></thead>';
    let bodyHtml = '<tbody>';
    projectRanking.slice(0, 15).forEach((proj, index) => {
        bodyHtml += `<tr class="hover:bg-dark-card transition-colors"><td>${index + 1}</td><td>${proj.projectName}</td><td>${formatNumber(proj.saleAmountSum, 0)}</td><td>${formatNumber(proj.houseAreaSum)}</td><td>${proj.transactionCount.toLocaleString()}</td><td>${formatNumber(proj.marketShare)}%</td><td>${formatNumber(proj.averagePrice)}</td><td>${formatNumber(proj.minPrice)}</td><td>${formatNumber(proj.maxPrice)}</td><td>${formatNumber(proj.medianPrice)}</td><td>${formatNumber(proj.avgParkingPrice, 0)}</td></tr>`;
    });
    bodyHtml += '</tbody>';
    let footerHtml = `<tfoot class="bg-dark-card font-bold"><tr class="border-t-2 border-gray-600"><td colspan="2">總計</td><td>${formatNumber(coreMetrics.totalSaleAmount, 0)}</td><td>${formatNumber(coreMetrics.totalHouseArea)}</td><td>${coreMetrics.transactionCount.toLocaleString()}</td><td colspan="6"></td></tr></tfoot>`;
    dom.rankingTable.innerHTML = headerHtml + bodyHtml + footerHtml;
}

function renderPriceBandReport() {
    if (!analysisDataCache || !analysisDataCache.priceBandAnalysis) return;
    const { priceBandAnalysis } = analysisDataCache;
    priceBandAnalysis.sort((a, b) => {
        if (a.rooms !== b.rooms) return a.rooms - b.rooms;
        return a.bathrooms - b.bathrooms;
    });
    const tableHeaders = ['房數', '衛浴數', '筆數', '平均房屋總價', '最低房屋總價', '1/4分位房屋總價', '中位數房屋總價', '3/4分位房屋總價', '最高房屋總價'];
    let headerHtml = '<thead><tr>' + tableHeaders.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
    let bodyHtml = '<tbody>';
    priceBandAnalysis.forEach(item => {
        bodyHtml += `<tr class="hover:bg-dark-card transition-colors">
            <td>${item.rooms}</td><td>${item.bathrooms}</td><td>${item.count.toLocaleString()}</td>
            <td>${formatNumber(item.avgPrice, 0)}</td><td>${formatNumber(item.minPrice, 0)}</td>
            <td>${formatNumber(item.q1Price, 0)}</td><td>${formatNumber(item.medianPrice, 0)}</td>
            <td>${formatNumber(item.q3Price, 0)}</td><td>${formatNumber(item.maxPrice, 0)}</td>
        </tr>`;
    });
    bodyHtml += '</tbody>';
    dom.priceBandTable.innerHTML = headerHtml + bodyHtml;
}

// 【修改】房屋單價分析渲染函式
function renderUnitPriceReport() {
    if (!analysisDataCache || !analysisDataCache.unitPriceAnalysis) return;
    const { residentialStats, typeComparison } = analysisDataCache.unitPriceAnalysis;

    // 渲染住宅單價統計表格
    const statsContainer = dom.residentialStatsTableContainer;
    if (residentialStats) {
        const avgPriceToShow = residentialStats.avgPrice[currentAverageType];
        
        statsContainer.innerHTML = `<table class="min-w-full divide-y divide-gray-800">
            <thead><tr><th class="w-1/2">統計項目</th><th class="w-1/2">房屋單價 (萬/坪)</th></tr></thead>
            <tbody>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">平均單價</td><td>${formatNumber(avgPriceToShow)}</td></tr>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">最低單價</td><td>${formatNumber(residentialStats.minPrice)}</td></tr>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">1/4分位數單價</td><td>${formatNumber(residentialStats.q1Price)}</td></tr>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">中位數單價</td><td>${formatNumber(residentialStats.medianPrice)}</td></tr>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">3/4分位數單價</td><td>${formatNumber(residentialStats.q3Price)}</td></tr>
                <tr class="hover:bg-dark-card"><td class="font-medium text-gray-300">最高單價</td><td>${formatNumber(residentialStats.maxPrice)}</td></tr>
            </tbody></table>`;
        
        dom.residentialStatsExtraInfo.innerHTML = `
            <p><span class="font-semibold text-cyan-400">最低房屋單價建案：</span>${residentialStats.minPriceProject || 'N/A'}</p>
            <p><span class="font-semibold text-purple-400">最高房屋單價建案：</span>${residentialStats.maxPriceProject || 'N/A'}</p>`;
    } else {
        statsContainer.innerHTML = '<p class="text-gray-500">無符合條件的住宅交易資料可供分析。</p>';
        dom.residentialStatsExtraInfo.innerHTML = '';
    }

    // 渲染建案類型比較表格
    const comparisonContainer = dom.typeComparisonTableContainer;
    if (typeComparison && typeComparison.length > 0) {
        let comparisonHtml = `<table class="min-w-full divide-y divide-gray-800">
            <thead><tr><th>建案名稱</th><th>住宅均價(萬/坪)</th><th>店舖均價(萬/坪)</th><th>店舖對住宅倍數</th><th>事務所均價(萬/坪)</th><th>事務所對住宅倍數</th></tr></thead>
            <tbody>`;
        typeComparison.forEach(item => {
            const residentialAvgToShow = item.residentialAvg[currentAverageType];
            const shopAvgToShow = item.shopAvg[currentAverageType];
            const officeAvgToShow = item.officeAvg[currentAverageType];

            comparisonHtml += `<tr class="hover:bg-dark-card">
                <td>${item.projectName}</td>
                <td>${formatNumber(residentialAvgToShow)}</td>
                <td>${shopAvgToShow > 0 ? formatNumber(shopAvgToShow) : '-'}</td>
                <td>${item.shopMultiple > 0 ? `${formatNumber(item.shopMultiple)} 倍` : '-'}</td>
                <td>${officeAvgToShow > 0 ? formatNumber(officeAvgToShow) : '-'}</td>
                <td>${item.officeMultiple > 0 ? `${formatNumber(item.officeMultiple)} 倍` : '-'}</td>
            </tr>`;
        });
        comparisonHtml += `</tbody></table>`;
        comparisonContainer.innerHTML = comparisonHtml;
    } else {
        comparisonContainer.innerHTML = '<p class="text-gray-500">無符合條件的建案可進行類型比較。</p>';
    }
}

function renderTable(data){if(!data||data.length===0)return;const isPresale=data[0]['交易類型']==='預售交易';const hiddenColumns=['編號','縣市代碼','交易類型','戶型'];const headers=Object.keys(data[0]);const headerRow=document.createElement('tr');headerRow.innerHTML='<th>操作</th>';headers.forEach(headerText=>{if(!hiddenColumns.includes(headerText)){const th=document.createElement('th');th.textContent=headerText;headerRow.appendChild(th);if(isPresale&&headerText==='戶別'){const newTh=document.createElement('th');newTh.textContent='戶型';headerRow.appendChild(newTh)}}});const thead=document.createElement('thead');thead.appendChild(headerRow);const tbody=document.createElement('tbody');data.forEach(row=>{const tr=document.createElement('tr');tr.className='hover:bg-dark-card transition-colors';tr.innerHTML=`<td><button class="details-btn bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1 rounded-md" data-id="${row['編號']}" data-type="${row['交易類型']}" data-county="${row['縣市代碼']}">附表</button></td>`;headers.forEach(header=>{if(!hiddenColumns.includes(header)){const td=document.createElement('td');let value=row[header];if(header==='地址'||header==='備註'){td.innerHTML=`<div class="scrollable-cell">${value??"-"}</div>`}else{td.textContent=(typeof value==='number'&&!Number.isInteger(value))?formatNumber(value):(value??"-")}tr.appendChild(td);if(isPresale&&header==='戶別'){const unitTypeTd=document.createElement('td');unitTypeTd.textContent=row['戶型']||'-';tr.appendChild(unitTypeTd)}}});tbody.appendChild(tr)});dom.resultsTable.innerHTML='';dom.resultsTable.append(thead,tbody)}
function renderPagination(){dom.paginationControls.innerHTML='';if(totalRecords===0&&currentPage===1){dom.paginationControls.innerHTML=`<span>共 0 筆資料</span>`;return}const totalPages=Math.ceil(totalRecords/pageSize);dom.paginationControls.innerHTML=`<div>共 ${totalRecords} 筆資料</div><div class="flex items-center space-x-2"><button id="prev-page" class="bg-gray-700 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors">上一頁</button><span class="px-4">第 ${currentPage} / ${totalPages>0?totalPages:1} 頁</span><button id="next-page" class="bg-gray-700 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors">下一頁</button></div>`;const prevBtn=document.getElementById('prev-page');const nextBtn=document.getElementById('next-page');prevBtn.disabled=currentPage===1;nextBtn.disabled=currentPage>=totalPages;prevBtn.onclick=()=>{currentPage--;fetchData()};nextBtn.onclick=()=>{currentPage++;fetchData()}}
async function showSubTableDetails(btn){const{id,type,county}=btn.dataset;dom.modalTitle.textContent=`附表詳細資料 (編號: ${id})`;dom.modalContent.innerHTML='<div class="loader mx-auto"></div>';dom.modal.classList.remove('hidden');try{if(!id||!type||!county||county==='undefined'){throw new Error(`前端參數不足，無法查詢附表。 (編號: ${id}, 類型: ${type}, 縣市: ${county})`)}const response=await fetch(SUB_DATA_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M'},body:JSON.stringify({id,type,county})});if(!response.ok){const errorResult=await response.json().catch(()=>({error:'無法從伺服器獲取附表資料'}));throw new Error(errorResult.error)}const result=await response.json();let contentHTML='<div class="space-y-6">';if(type!=='預售交易')contentHTML+=renderSubTable('建物資料',result.build);contentHTML+=renderSubTable('土地資料',result.land);contentHTML+=renderSubTable('車位資料',result.park);contentHTML=(contentHTML==='<div class="space-y-6">')?'<p>此筆紀錄沒有對應的附表資料。</p>':contentHTML+'</div>';dom.modalContent.innerHTML=contentHTML}catch(error){dom.modalContent.innerHTML=`<p class="text-red-400">查詢失敗: ${error.message}</p>`}}
function renderSubTable(title,records){if(!records||!Array.isArray(records)||records.length===0){return`<div class="mb-4"><h3 class="text-lg font-semibold text-cyan-400 mb-2">${title}</h3><p class="text-sm text-gray-500">無資料</p></div>`}const headers=Object.keys(records[0]).filter(h=>h!=='id'&&h!=='編號');let html=`<div><h3 class="text-lg font-semibold text-cyan-400 mb-2">${title}</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead><tr class="border-b border-gray-600">`;headers.forEach(header=>{html+=`<th class="py-2 pr-2 font-medium text-gray-400">${header}</th>`});html+='</tr></thead><tbody>';records.forEach(record=>{html+='<tr class="border-b border-gray-700 last:border-b-0">';headers.forEach(header=>{html+=`<td class="py-2 pr-2">${record[header]??"-"}</td>`});html+='</tr>'});html+='</tbody></table></div></div>';return html}
function toggleAnalyzeButtonState(){const isCountySelected=!!dom.countySelect.value;const isValidType=dom.typeSelect.value==='預售交易'||dom.typeSelect.value==='中古交易';dom.analyzeBtn.disabled=!(isCountySelected&&isValidType)}
function updateDistrictOptions(){const selectedCounty=dom.countySelect.value;dom.districtSelect.innerHTML='<option value="">全部</option>';if(selectedCounty&&districtData[selectedCounty]){districtData[selectedCounty].forEach(districtName=>{const option=document.createElement('option');option.value=districtName;option.textContent=districtName;dom.districtSelect.appendChild(option)});dom.districtSelect.disabled=false;dom.projectNameInput.disabled=false;dom.projectNameInput.placeholder="輸入建案名稱搜尋..."}else{dom.districtSelect.disabled=true;dom.projectNameInput.disabled=true;dom.projectNameInput.placeholder="請先選縣市..."}toggleAnalyzeButtonState();clearSelectedProjects()}
function clearSelectedProjects(){selectedProjects=[];renderProjectTags();const suggestionCheckboxes=dom.projectNameSuggestions.querySelectorAll('input[type="checkbox"]');suggestionCheckboxes.forEach(cb=>cb.checked=false)}
function onProjectInput(){clearTimeout(suggestionDebounceTimer);suggestionDebounceTimer=setTimeout(()=>{fetchProjectNameSuggestions(dom.projectNameInput.value)},300)}
async function fetchProjectNameSuggestions(query){const county=dom.countySelect.value;const countyCode=countyCodeMap[county];if(!query.trim()||!countyCode){dom.projectNameSuggestions.classList.add('hidden');return}try{const response=await fetch(PROJECT_NAMES_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M'},body:JSON.stringify({countyCode,query})});if(!response.ok)throw new Error(`伺服器錯誤: ${response.status}`);const names=await response.json();renderSuggestions(names)}catch(error){console.error("獲取建案建議失敗:",error);dom.projectNameSuggestions.innerHTML=`<div class="p-2 text-red-400">讀取建議失敗。</div>`;dom.projectNameSuggestions.classList.remove('hidden')}}
function renderSuggestions(names){if(names.length===0){dom.projectNameSuggestions.innerHTML='<div class="p-2 text-gray-500">無相符建案</div>'}else{dom.projectNameSuggestions.innerHTML=names.map(name=>{const isChecked=selectedProjects.includes(name);return`<label class="suggestion-item" data-name="${name}"><input type="checkbox" ${isChecked?'checked':''}><span class="flex-grow">${name}</span></label>`}).join('')}dom.projectNameSuggestions.classList.remove('hidden')}
function onSuggestionClick(e){const target=e.target.closest('.suggestion-item');if(!target)return;const name=target.dataset.name;const checkbox=target.querySelector('input[type="checkbox"]');if(!name||!checkbox)return;setTimeout(()=>{if(checkbox.checked){if(!selectedProjects.includes(name))selectedProjects.push(name)}else{selectedProjects=selectedProjects.filter(p=>p!==name)}renderProjectTags()},0)}
function onTagRemove(e){if(e.target.classList.contains('project-tag-remove')){removeProject(e.target.dataset.name)}}
function removeProject(name){selectedProjects=selectedProjects.filter(p=>p!==name);renderProjectTags();const openSuggestionCheckbox=dom.projectNameSuggestions.querySelector(`label[data-name="${name}"] input`);if(openSuggestionCheckbox)openSuggestionCheckbox.checked=false}
function renderProjectTags(){const tags=dom.projectNameContainer.querySelectorAll('.project-tag');tags.forEach(tag=>tag.remove());dom.projectNameContainer.insertBefore(dom.projectNameInput,dom.projectNameContainer.firstChild);selectedProjects.forEach(name=>{const tagElement=document.createElement('span');tagElement.className='project-tag';tagElement.textContent=name;const removeBtn=document.createElement('span');removeBtn.className='project-tag-remove';removeBtn.innerHTML='&times;';removeBtn.dataset.name=name;tagElement.appendChild(removeBtn);dom.projectNameContainer.insertBefore(tagElement,dom.projectNameInput)});dom.clearProjectsBtn.classList.toggle('hidden',selectedProjects.length===0)}

initialize();
</script>
</body>
</html>
