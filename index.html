<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸å‹•ç”¢æ•¸æ“šæŸ¥è©¢å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1d29',
                        'dark-card': '#252836',
                        'cyan-accent': '#06b6d4',
                        'purple-accent': '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: #1a1d29;
            color: #e5e7eb;
        }
        .glass-card {
            background: rgba(37, 40, 54, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-input, .form-select {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #d1d5db;
        }
        .form-input:focus, .form-select:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.5);
            outline: none;
        }
        .loader { border: 4px solid #374151; border-top: 4px solid #06b6d4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
        .modal-container { background: #1a1d29; padding: 1.5rem; border-radius: 12px; width: 95%; max-width: 1400px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid #4b5563; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay:not(.hidden) .modal-container { transform: scale(1); }
        
        /* Analysis Report Table Styles */
        .analysis-table th { cursor: pointer; user-select: none; }
        .analysis-table th:hover { background-color: #374151; }
        .analysis-table th.sorted { background-color: #06b6d4; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-white tracking-tight">ä¸å‹•ç”¢æ•¸æ“šæŸ¥è©¢å¹³å°</h1>
            <p class="mt-2 text-lg text-gray-400">æ‚¨çš„å°ˆå±¬æ•¸æ“šæŸ¥è©¢èˆ‡åˆ†æå·¥å…·ã€‚</p>
        </header>
        
        <main>
            <!-- Filter Form (Assuming this part is the same) -->
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                <div id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 items-end">
                    <div>
                        <label for="county" class="block text-sm font-medium text-gray-300">ç¸£å¸‚</label>
                        <select id="county" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                            <option value="">è«‹é¸æ“‡ç¸£å¸‚</option>
                        </select>
                    </div>
                    <div>
                        <label for="building-type" class="block text-sm font-medium text-gray-300">å»ºç‰©å‹æ…‹</label>
                        <select id="building-type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ä½å®…å¤§æ¨“(11å±¤å«ä»¥ä¸Šæœ‰é›»æ¢¯)">ä½å®…å¤§æ¨“</option>
                            <option value="è¯å»ˆ(10å±¤å«ä»¥ä¸‹æœ‰é›»æ¢¯)">è¯å»ˆ</option>
                            <option value="å…¬å¯“(5å±¤å«ä»¥ä¸‹ç„¡é›»æ¢¯)">å…¬å¯“</option>
                            <option value="å¥—æˆ¿(1æˆ¿(1å»³)1è¡›)">å¥—æˆ¿</option>
                        </select>
                    </div>
                    <div class="xl:col-span-2">
                        <label for="project-name-input" class="block text-sm font-medium text-gray-300">å»ºæ¡ˆåç¨± (å¯è¤‡é¸)</label>
                        <input type="text" id="project-name-input" placeholder="è¼¸å…¥å»ºæ¡ˆ, ä»¥é€—è™Ÿåˆ†éš”" class="form-input mt-1 block w-full rounded-md">
                    </div>
                    <div class="sm:col-span-2 lg:col-span-4 xl:col-span-6 flex justify-end items-center gap-4">
                        <button id="analyze-btn" class="bg-gradient-to-r from-cyan-accent to-purple-accent text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all">
                            æ•¸æ“šåˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Analysis Report Modal -->
    <div id="analysis-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">é å”®å±‹åˆ†æå ±å‘Š - æ ¸å¿ƒæŒ‡æ¨™èˆ‡æ’å</h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="modal-content" class="flex-grow overflow-y-auto">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const dom = {
            countySelect: document.getElementById('county'),
            buildingTypeSelect: document.getElementById('building-type'),
            projectNameInput: document.getElementById('project-name-input'),
            analyzeBtn: document.getElementById('analyze-btn'),
            analysisModal: document.getElementById('analysis-modal'),
            modalContent: document.getElementById('modal-content'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
        };

        // --- API Endpoint ---
        const ANALYSIS_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/analyze-data';

        // --- State ---
        let currentSortBy = 'total_price'; // é è¨­æ’åºæ¬„ä½

        // --- County Data ---
        const countyCodeMap = { "è‡ºåŒ—å¸‚": "A", "æ–°åŒ—å¸‚": "F", "æ¡ƒåœ’å¸‚": "H", "è‡ºä¸­å¸‚": "B", "è‡ºå—å¸‚": "D", "é«˜é›„å¸‚": "E", "åŸºéš†å¸‚": "C", "æ–°ç«¹å¸‚": "O", "å˜‰ç¾©å¸‚": "I", "æ–°ç«¹ç¸£": "J", "è‹—æ —ç¸£": "K", "å½°åŒ–ç¸£": "N", "å—æŠ•ç¸£": "M", "é›²æ—ç¸£": "P", "å˜‰ç¾©ç¸£": "Q", "å±æ±ç¸£": "T", "å®œè˜­ç¸£": "G", "èŠ±è“®ç¸£": "U", "è‡ºæ±ç¸£": "V", "æ¾æ¹–ç¸£": "X", "é‡‘é–€ç¸£": "W", "é€£æ±Ÿç¸£": "Z" };

        // --- Initialization ---
        function initialize() {
            // å¡«å……ç¸£å¸‚ä¸‹æ‹‰é¸å–®
            Object.keys(countyCodeMap).forEach(countyName => {
                const option = document.createElement('option');
                option.value = countyName;
                option.textContent = countyName;
                dom.countySelect.appendChild(option);
            });

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            dom.analyzeBtn.addEventListener('click', () => analyzeData(currentSortBy));
            dom.modalCloseBtn.addEventListener('click', () => dom.analysisModal.classList.add('hidden'));
            // ç›£è½ modal å…§å®¹çš„é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼è™•ç†æ’åº
            dom.modalContent.addEventListener('click', handleSortClick);
        }

        // --- Main Analysis Function ---
        async function analyzeData(sortBy = 'total_price') {
            const county = dom.countySelect.value;
            if (!county) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç¸£å¸‚');
                return;
            }

            currentSortBy = sortBy; // æ›´æ–°ç•¶å‰æ’åºç‹€æ…‹

            // é¡¯ç¤ºè¼‰å…¥ä¸­çš„ modal
            dom.analysisModal.classList.remove('hidden');
            dom.modalContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';

            // æ”¶é›†ç¯©é¸æ¢ä»¶
            const projectNames = dom.projectNameInput.value.split(',').map(name => name.trim()).filter(Boolean);
            const requestFilters = {
                countyCode: countyCodeMap[county],
                buildingType: dom.buildingTypeSelect.value || null,
                projectNames: projectNames.length > 0 ? projectNames : null
            };

            try {
                const response = await fetch(ANALYSIS_ENDPOINT, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M'
                    },
                    body: JSON.stringify({
                        filters: requestFilters,
                        tab: 'core_and_ranking',
                        sortBy: currentSortBy
                    })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                renderAnalysisReport(data);

            } catch (error) {
                console.error("æ•¸æ“šåˆ†æå¤±æ•—:", error);
                dom.modalContent.innerHTML = `<div class="p-8 text-center text-red-400">æ•¸æ“šåˆ†æå¤±æ•—: ${error.message}</div>`;
            }
        }

        // --- Rendering Functions ---
        function renderAnalysisReport(data) {
            if (!data) {
                dom.modalContent.innerHTML = '<div class="p-8 text-center">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åˆ†æè³‡æ–™ã€‚</div>';
                return;
            }

            const { core_metrics, project_ranking, ranking_summary } = data;
            
            // ä½¿ç”¨ toLocaleString ä¾†æ ¼å¼åŒ–æ•¸å­—
            const formatNumber = (num, digits = 2) => {
                if (typeof num !== 'number') return '-';
                return num.toLocaleString('en-US', { minimumFractionDigits: digits, maximumFractionDigits: digits });
            };

            const metricsHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">å¸‚å ´å»åŒ–ç¸½éŠ·å”®é‡‘é¡</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['å¸‚å ´å»åŒ–ç¸½éŠ·å”®é‡‘é¡'], 0)} <span class="text-base font-normal text-gray-400">è¬</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">ç¸½éŠ·å»åŒ–æˆ¿å±‹åªæ•¸</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['ç¸½éŠ·å»åŒ–æˆ¿å±‹åªæ•¸'], 0)} <span class="text-base font-normal text-gray-400">åª</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">ç¸½è¡Œæ”¿å€å¹³å‡å–®åƒ¹</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['ç¸½è¡Œæ”¿å€å¹³å‡å–®åƒ¹'])} <span class="text-base font-normal text-gray-400">è¬/åª</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">è¡Œæ”¿å€å»åŒ–ç­†æ•¸</h3>
                        <p class="text-2xl font-bold text-white">${(core_metrics?.['è¡Œæ”¿å€å»åŒ–ç­†æ•¸'] || 0).toLocaleString()} <span class="text-base font-normal text-gray-400">ç­†</span></p>
                    </div>
                </div>
            `;
            
            // æ¨™é ­å’Œå°æ‡‰çš„æ’åºéµ
            const headers = [
                { label: 'æ’å', sortKey: null },
                { label: 'å»ºæ¡ˆåç¨±', sortKey: null },
                { label: 'æˆ¿å±‹é¢ç©(åª)', sortKey: 'total_area' },
                { label: 'è³‡æ–™ç­†æ•¸', sortKey: 'transaction_count' },
                { label: 'äº¤æ˜“ç¸½åƒ¹(è¬)', sortKey: 'total_price' },
                { label: 'å¸‚å ´ä½”æ¯”(%)', sortKey: null },
                { label: 'å¹³å‡å–®åƒ¹(è¬)', sortKey: 'avg_unit_price' },
                { label: 'æœ€ä½å–®åƒ¹(è¬)', sortKey: null },
                { label: 'æœ€é«˜å–®åƒ¹(è¬)', sortKey: null },
                { label: 'å–®åƒ¹ä¸­ä½æ•¸(è¬)', sortKey: null },
                { label: 'è»Šä½å¹³å‡å–®åƒ¹', sortKey: null },
            ];

            const tableHeaderHTML = headers.map(h => {
                const isSortable = h.sortKey !== null;
                const isSorted = h.sortKey === currentSortBy;
                return `<th class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider ${isSortable ? 'hover:bg-gray-700' : ''} ${isSorted ? 'bg-cyan-600 text-white' : ''}" ${isSortable ? `data-sort="${h.sortKey}"` : ''}>
                    ${h.label} ${isSortable ? 'ğŸ”½' : ''}
                </th>`;
            }).join('');

            const tableRowsHTML = project_ranking?.map(row => `
                <tr class="border-b border-gray-700 hover:bg-dark-card">
                    <td class="p-3 text-sm">${row['æ’å']}</td>
                    <td class="p-3 text-sm font-medium text-cyan-400">${row['å»ºæ¡ˆåç¨±']}</td>
                    <td class="p-3 text-sm">${formatNumber(row['æˆ¿å±‹é¢ç©(åª)'], 2)}</td>
                    <td class="p-3 text-sm">${row['è³‡æ–™ç­†æ•¸']}</td>
                    <td class="p-3 text-sm">${formatNumber(row['äº¤æ˜“ç¸½åƒ¹(è¬)'], 0)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['å¸‚å ´ä½”æ¯”(%)'], 2)}%</td>
                    <td class="p-3 text-sm font-bold">${formatNumber(row['å¹³å‡å–®åƒ¹(è¬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['æœ€ä½å–®åƒ¹(è¬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['æœ€é«˜å–®åƒ¹(è¬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['å–®åƒ¹ä¸­ä½æ•¸(è¬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['è»Šä½å¹³å‡å–®åƒ¹'], 2)}</td>
                </tr>
            `).join('') || '<tr><td colspan="11" class="p-8 text-center">ç„¡å»ºæ¡ˆæ’åè³‡æ–™</td></tr>';

            const summaryRowHTML = `
                <tr class="bg-dark-card font-bold">
                    <td class="p-3 text-sm" colspan="2">ç¸½è¨ˆ (ç¯©é¸å¾Œæ‰€æœ‰è³‡æ–™)</td>
                    <td class="p-3 text-sm">${formatNumber(ranking_summary?.['æˆ¿å±‹é¢ç©_ç¸½å’Œ'], 2)}</td>
                    <td class="p-3 text-sm">${(ranking_summary?.['è³‡æ–™ç­†æ•¸_ç¸½å’Œ'] || 0).toLocaleString()}</td>
                    <td class="p-3 text-sm">${formatNumber(ranking_summary?.['äº¤æ˜“ç¸½åƒ¹_ç¸½å’Œ'], 0)}</td>
                    <td class="p-3 text-sm" colspan="6"></td>
                </tr>
            `;

            const tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full analysis-table">
                        <thead class="bg-gray-800">
                            <tr>${tableHeaderHTML}</tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${tableRowsHTML}
                        </tbody>
                        <tfoot>
                            ${summaryRowHTML}
                        </tfoot>
                    </table>
                </div>
            `;

            dom.modalContent.innerHTML = metricsHTML + tableHTML;
        }
        
        // --- Event Handlers ---
        function handleSortClick(e) {
            const header = e.target.closest('th');
            if (header && header.dataset.sort) {
                const sortBy = header.dataset.sort;
                analyzeData(sortBy);
            }
        }

        // --- Run Initialization ---
        initialize();
    </script>
</body>
</html>
