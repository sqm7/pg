<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>實價登錄查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sub-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .sub-table th, .sub-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .sub-table th {
            background-color: #f2f2f2;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-btn {
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">實價登錄查詢系統</h1>
        
        <!-- 篩選表單 -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">縣市</label>
                    <select name="county" class="w-full p-2 border rounded">
                        <option value="A">台北市</option>
                        <option value="F">新北市</option>
                        <!-- 其他縣市選項 -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">交易類型</label>
                    <select name="transactionType" class="w-full p-2 border rounded">
                        <option value="中古交易">中古交易</option>
                        <option value="預售交易">預售交易</option>
                        <option value="租賃交易">租賃交易</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        查詢
                    </button>
                </div>
            </form>
        </div>

        <!-- 結果表格 -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div id="loading" class="text-center py-4 hidden">
                <div class="loader mx-auto"></div>
                <p>資料載入中...</p>
            </div>
            <div id="results" class="overflow-x-auto">
                <table id="resultsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <!-- 表頭會由 JavaScript 動態生成 -->
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 資料會由 JavaScript 動態生成 -->
                    </tbody>
                </table>
                <div id="pagination" class="mt-4 flex justify-between items-center">
                    <!-- 分頁控制項會由 JavaScript 動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 附表彈出視窗 -->
    <div id="subTableModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('subTableModal').style.display='none'">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // 常數定義
        const API_URL = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-data';
        const SUB_DATA_API_URL = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-sub-data';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZjoienhibWJiZnJ6YnR1dWV5c2ljb2MiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1MDY4ODk4OSwiZXhwIjoyMDY2MjY0OTg5fQ.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M';
        
        // DOM 元素
        const dom = {
            searchForm: document.getElementById('searchForm'),
            resultsTable: document.getElementById('resultsTable'),
            results: document.getElementById('results'),
            loading: document.getElementById('loading'),
            pagination: document.getElementById('pagination'),
            modal: document.getElementById('subTableModal'),
            modalContent: document.getElementById('modalContent')
        };

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 表單提交事件
            dom.searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await fetchData();
            });

            // 點擊彈窗外部關閉
            window.onclick = function(event) {
                if (event.target === dom.modal) {
                    dom.modal.style.display = 'none';
                }
            };
        });

        // 查詢資料
        async function fetchData() {
            const formData = new FormData(dom.searchForm);
            const params = new URLSearchParams(formData).toString();
            
            dom.loading.classList.remove('hidden');
            dom.results.classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('查詢失敗');
                }

                const result = await response.json();
                renderResults(result.data || []);
            } catch (error) {
                console.error('Error:', error);
                alert(`查詢時發生錯誤: ${error.message}`);
            } finally {
                dom.loading.classList.add('hidden');
                dom.results.classList.remove('hidden');
            }
        }

        // 渲染結果表格
        function renderResults(data) {
            if (!data || data.length === 0) {
                dom.resultsTable.innerHTML = '<tr><td colspan="100%" class="text-center py-4">查無資料</td></tr>';
                dom.pagination.innerHTML = '';
                return;
            }

            // 取得所有欄位名稱
            const headers = Object.keys(data[0]);
            
            // 渲染表頭
            let thead = document.createElement('thead');
            let headerRow = document.createElement('tr');
            
            headers.forEach(header => {
                if (header !== '編號' && header !== 'id') { // 隱藏編號欄位
                    let th = document.createElement('th');
                    th.textContent = header;
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    headerRow.appendChild(th);
                }
            });
            
            // 添加操作欄位
            let actionTh = document.createElement('th');
            actionTh.textContent = '操作';
            actionTh.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            headerRow.appendChild(actionTh);
            
            thead.appendChild(headerRow);
            
            // 渲染表格內容
            let tbody = document.createElement('tbody');
            data.forEach(row => {
                let tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                headers.forEach(header => {
                    if (header !== '編號' && header !== 'id') { // 隱藏編號欄位
                        let td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                        
                        let value = row[header];
                        if (typeof value === 'number' && ['交易總價', '車位總價', '房屋總價', '車位面積', '房屋面積', '主建物面積', '附屬建物面積', '陽台面積', '租賃面積'].includes(header)) {
                            value = new Intl.NumberFormat('zh-TW').format(value);
                        }
                        
                        td.textContent = value || '-';
                        tr.appendChild(td);
                    }
                });
                
                // 添加查看附表按鈕
                let actionTd = document.createElement('td');
                actionTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
                
                let viewBtn = document.createElement('button');
                viewBtn.textContent = '查看附表';
                viewBtn.className = 'text-blue-600 hover:text-blue-900';
                viewBtn.onclick = () => showSubTableDetails(row);
                
                actionTd.appendChild(viewBtn);
                tr.appendChild(actionTd);
                
                tbody.appendChild(tr);
            });
            
            // 清空並更新表格
            dom.resultsTable.innerHTML = '';
            dom.resultsTable.appendChild(thead);
            dom.resultsTable.appendChild(tbody);
            
            // 更新分頁控制（如果需要）
            // renderPagination();
        }

        // 顯示附表詳細資料
        async function showSubTableDetails(rowData) {
            if (!rowData || !rowData.編號) {
                alert('無法取得資料編號');
                return;
            }

            const modal = document.getElementById('subTableModal');
            const modalContent = document.getElementById('modalContent');
            
            // 顯示載入中
            modalContent.innerHTML = '<div class="loader mx-auto"></div><p class="text-center">資料載入中...</p>';
            modal.style.display = 'block';

            try {
                const type = document.querySelector('select[name="transactionType"]').value;
                const county = document.querySelector('select[name="county"]').value;
                
                if (!type || !county) {
                    throw new Error('請選擇縣市和交易類型');
                }

                const response = await fetch(SUB_DATA_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        id: rowData.編號,
                        type: type,
                        county: county
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // 渲染附表內容
                let html = `<h2 class="text-xl font-bold mb-4">${type} - 附表資料 (編號: ${rowData.編號})</h2>`;
                
                // 檢查並顯示每種附表
                const subTables = {
                    '建物資料': result.build,
                    '土地資料': result.land,
                    '車位資料': result.park
                };
                
                let hasData = false;
                
                for (const [title, data] of Object.entries(subTables)) {
                    if (data && data.length > 0) {
                        hasData = true;
                        html += `<div class="mb-8"><h3 class="text-lg font-semibold mb-2">${title}</h3>`;
                        html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
                        
                        // 表頭
                        html += '<thead><tr class="bg-gray-50">';
                        Object.keys(data[0]).forEach(key => {
                            html += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${key}</th>`;
                        });
                        html += '</tr></thead>';
                        
                        // 資料行
                        html += '<tbody class="bg-white divide-y divide-gray-200">';
                        data.forEach(item => {
                            html += '<tr>';
                            Object.values(item).forEach(val => {
                                html += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${val || '-'}</td>`;
                            });
                            html += '</tr>';
                        });
                        html += '</tbody></table></div></div>';
                    }
                }
                
                if (!hasData) {
                    html += '<p class="text-gray-500">此筆資料沒有相關的附表資訊。</p>';
                }
                
                modalContent.innerHTML = html;
                
            } catch (error) {
                console.error('Error fetching sub data:', error);
                modalContent.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                        <h3 class="font-bold">載入失敗</h3>
                        <p>${error.message}</p>
                    </div>
                    <button 
                        onclick="document.getElementById('subTableModal').style.display='none'" 
                        class="mt-4 px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                    >
                        關閉
                    </button>
                `;
            }
        }
    </script>
</body>
</html>
