<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>不動產數據查詢平台</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-bg': '#1a1d29',
        'dark-card': '#252836',
        'cyan-accent': '#06b6d4',
        'purple-accent': '#8b5cf6',
      }
    }
  }
}
</script>
<style>
body { font-family: 'Inter', 'Noto Sans TC', sans-serif;
background: #1a1d29; color: #e5e7eb; }
.glass-card { background: rgba(37, 40, 54, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
}
.form-input, .form-select { background-color: #1f2937; border: 1px solid #4b5563; color: #d1d5db; }
.form-input:focus, .form-select:focus, .form-input:has(input:focus) { border-color: #06b6d4;
box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.5); outline: none; }
select:disabled, input:disabled { background-color: #374151; cursor: not-allowed; opacity: 0.7;
}
.table-container { overflow-y: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { border-bottom: 1px solid #374151; padding: 0.75rem 1rem;
text-align: left; font-size: 0.875rem; white-space: nowrap; }
thead th { background-color: #252836; position: sticky; top: 0; z-index: 10; font-weight: 600;
color: #9ca3af; }
.loader { border: 4px solid #374151; border-top: 4px solid #06b6d4; border-radius: 50%; width: 40px; height: 40px;
animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg);
} }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex;
align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
.modal-container { background: #252836; padding: 2rem; border-radius: 12px;
width: 90%; max-width: 1200px; max-height: 85vh; overflow-y: auto; border: 1px solid #4b5563; transform: scale(0.95); transition: transform 0.3s ease;
}
.modal-overlay:not(.hidden) .modal-container { transform: scale(1); }
.project-tag { display: inline-flex; align-items: center; background-color: #4b5563; color: #d1d5db; padding: 0.25rem 0.75rem; border-radius: 9999px;
font-size: 0.875rem; flex-shrink: 0; }
.project-tag-remove { margin-left: 0.5rem; cursor: pointer; font-weight: bold; }
.project-tag-remove:hover { color: #f87171; }
#project-name-suggestions { max-height: 200px;
overflow-y: auto; }
.suggestion-item { display: flex; align-items: center; padding: 0.5rem 1rem; cursor: pointer; }
.suggestion-item:hover, .suggestion-item.active { background-color: #374151;
}
.suggestion-item input[type="checkbox"] { margin-right: 0.75rem; height: 1rem; width: 1rem; border-radius: 0.25rem; border-color: #6b7280; background-color: #374151; color: #06b6d4; cursor: pointer;
}
.suggestion-item input[type="checkbox"]:focus { ring: #06b6d4; }
.scrollable-cell { max-width: 25ch; overflow-x: auto; white-space: nowrap; padding-top: 4px; padding-bottom: 4px;
}
.scrollable-cell::-webkit-scrollbar, #project-name-container::-webkit-scrollbar { height: 4px; }
.scrollable-cell::-webkit-scrollbar-track, #project-name-container::-webkit-scrollbar-track { background: transparent; }
.scrollable-cell::-webkit-scrollbar-thumb, #project-name-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px;
}
.tab-button { padding: 0.75rem 1.5rem; font-medium; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: #9ca3af; }
.tab-button.active { color: #06b6d4;
border-bottom-color: #06b6d4; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.metric-card { background-color: #1f2937; padding: 1.5rem; border-radius: 0.75rem;
border: 1px solid #374151; }
.metric-card-title { font-size: 0.875rem; color: #9ca3af; margin-bottom: 0.5rem; }
.metric-card-value { font-size: 2rem; font-weight: 700; color: #e5e7eb;
}
.metric-card-unit { font-size: 1rem; color: #6b7280; margin-left: 0.5rem; }
.sortable-th { cursor: pointer; user-select: none; }
.sortable-th:hover { color: #e5e7eb;
}
.sortable-th .sort-icon { display: inline-block; margin-left: 0.5rem; color: #6b7280; transition: all 0.2s; }
.sortable-th.asc .sort-icon { transform: rotate(180deg); color: #06b6d4;
}
.sortable-th.desc .sort-icon { color: #06b6d4; }
.report-section-title { font-size: 1.25rem; font-weight: 600; color: #e5e7eb; margin-bottom: 1rem; padding-bottom: 0.5rem;
border-bottom: 1px solid #374151;}
.avg-type-btn { color: #9ca3af; }
.avg-type-btn.active { background-color: #06b6d4; color: #ffffff;
}
.capsule-btn {
    padding: 0.375rem 1rem;
    border-radius: 9999px;
    border: 1px solid #4b5563;
    background-color: transparent;
    color: #d1d5db;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    white-space: nowrap;
}
.capsule-btn.active, .capsule-btn:hover {
    background-color: #06b6d4;
    border-color: #06b6d4;
    color: white;
}
.sub-tab-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #374151;
    padding-bottom: 0.75rem;
}
.sub-tab-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    color: #9ca3af;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}
.sub-tab-btn.active, .sub-tab-btn:hover {
    background-color: #252836;
    color: #e5e7eb;
}
</style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-screen-2xl mx-auto">
  <header class="mb-8 text-center">
    <h1 class="text-4xl font-extrabold text-white tracking-tight">不動產數據查詢平台</h1>
    <p class="mt-2 text-lg text-gray-400">您的專屬數據查詢與分析工具。</p>
  </header>

  <main>
    <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
      <div id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 items-end">
        <div><label for="county" class="block text-sm font-medium text-gray-300">縣市</label><select id="county" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md"><option value="">請選擇縣市</option></select></div>
        <div><label for="district" class="block text-sm font-medium text-gray-300">行政區</label><select id="district" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md" disabled><option value="">請先選縣市</option></select></div>
 
        
        <div>
            <label for="type" class="block text-sm font-medium text-gray-300">交易類型</label>
            <select id="type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                <option value="預售交易" selected>預售交易</option>
                <option value="中古交易" disabled>中古交易 (開發中)</option>
         
                <option value="租賃交易" disabled>租賃交易 (開發中)</option>
            </select>
        </div>
        <div><label for="building-type" class="block text-sm font-medium text-gray-300">建物型態</label><select id="building-type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md"><option value="">全部</option><option value="住宅大樓(11層含以上有電梯)">住宅大樓</option><option value="華廈(10層含以下有電梯)">華廈</option><option value="公寓(5層含以下無電梯)">公寓</option><option value="套房(1房(1廳)1衛)">套房</option><option value="透天厝">透天厝</option><option value="店面(店鋪)">店面</option><option value="辦公商業大樓">辦公商業大樓</option><option value="工廠">工廠</option><option value="倉庫">倉庫</option><option value="其他">其他</option></select></div>
        <div class="xl:col-span-2"><div class="flex justify-between items-center"><label for="project-name-input" class="block text-sm font-medium text-gray-300">建案名稱 (可複選)</label><button id="clear-projects-btn" class="text-xs text-cyan-400 hover:text-cyan-300 hidden transition-opacity">清除選取</button></div><div class="relative mt-1"><div id="project-name-container" class="form-input flex flex-nowrap items-center gap-2 p-1 min-h-[42px] rounded-md 
overflow-x-auto"><input type="text" id="project-name-input" placeholder="請先選縣市..." class="bg-transparent flex-grow outline-none text-base py-1 px-2" disabled></div><div id="project-name-suggestions" class="absolute z-20 w-full mt-1 bg-dark-card border border-gray-600 rounded-md shadow-lg hidden"></div></div></div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:col-span-2 lg:col-span-4 xl:col-span-4">
            <div>
                <label for="date-range" class="block text-sm font-medium text-gray-300">快捷時間</label>
                <select id="date-range" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
     
                    <option value="custom">自訂範圍</option><option value="7d">近7天</option><option value="14d">近14天</option><option value="30d">近30天</option><option value="1q">近一季 (3個月)</option><option value="2q">近兩季 (6個月)</option><option value="3q">近三季 (9個月)</option><option value="1y">近一年 (12個月)</option><option value="this_year">今年以來</option><option value="last_2_years">去年＋今年</option><option value="last_3_years">前年＋去年＋今年</option>
                </select>
            </div>
            <div><label for="date-start" class="block text-sm font-medium text-gray-300">起始日期</label><input type="date" id="date-start" class="form-input mt-1 block w-full pl-3 pr-2 py-2 text-base rounded-md"></div>
            <div><label for="date-end" 
class="block text-sm font-medium text-gray-300">結束日期</label><input type="date" id="date-end" class="form-input mt-1 block w-full pl-3 pr-2 py-2 text-base rounded-md"></div>
        </div>
        <div class="sm:col-span-2 lg:col-span-4 xl:col-span-6 flex justify-end items-center gap-4">
          <button id="analyze-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">分析報表</button>
          <button id="search-btn" class="bg-gradient-to-r from-cyan-accent to-purple-accent text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all">查詢資料列表</button>
        </div>
      </div>
    
    </div>
  
    <div id="results-container" class="glass-card p-6 rounded-xl shadow-lg">
      <div id="tabs-container" class="border-b border-gray-700 mb-6 hidden">
        <nav class="flex -mb-px">
          <button data-tab="ranking-report" class="tab-button active">核心指標與排名</button>
          <button data-tab="price-band-report" class="tab-button">總價帶分析</button>
          <button data-tab="unit-price-report" class="tab-button">房屋單價分析</button>
          <button data-tab="parking-report" class="tab-button">車位單價分析</button>
          <button data-tab="velocity-report" class="tab-button">去化時間分析</button>
          <button data-tab="data-list" class="tab-button">資料列表</button>
        </nav>
      </div>

     
      <div id="message-area" class="text-center p-8 text-gray-400">請設定篩選條件後點擊查詢或分析。</div>

      <div id="ranking-report-content" class="tab-content">...</div>
      
      <div id="price-band-report-content" class="tab-content">...</div>

      <div id="unit-price-report-content" class="tab-content">...</div>

      <div id="parking-report-content" class="tab-content">...</div>

      <div id="velocity-report-content" class="tab-content">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">房型篩選器</label>
            <div id="velocity-room-filter-container" class="flex flex-wrap gap-2"></div>
        </div>

        <div id="velocity-sub-tabs-container">
            <nav class="sub-tab-nav">
                <button data-view="weekly" class="sub-tab-btn">每週去化</button>
                <button data-view="monthly" class="sub-tab-btn active">每月去化</button>
                <button data-view="quarterly" class="sub-tab-btn">每季去化</button>
                <button data-view="yearly" class="sub-tab-btn">年度去化</button>
            </nav>
        </div>
        
        <div id="velocity-table-container" class="overflow-x-auto"></div>
      </div>

      <div id="data-list-content" class="tab-content">...</div>
    </div>
  </main>
</div>

<div id="details-modal" class="modal-overlay hidden">...</div>

<script type="module">
// API Endpoints
const EDGE_FUNCTION_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-data';
const SUB_DATA_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-sub-data';
const PROJECT_NAMES_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/query-names';
const RANKING_ANALYSIS_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/analyze-project-ranking';

// DOM Elements
const dom = {
  countySelect: document.getElementById('county'),
  districtSelect: document.getElementById('district'),
  typeSelect: document.getElementById('type'),
  buildingTypeSelect: document.getElementById('building-type'),
  dateRangeSelect: document.getElementById('date-range'),
  dateStartInput: document.getElementById('date-start'),
  dateEndInput: document.getElementById('date-end'),
  searchBtn: document.getElementById('search-btn'),
  analyzeBtn: document.getElementById('analyze-btn'),
  messageArea: document.getElementById('message-area'),
  tabsContainer: document.getElementById('tabs-container'),
  // 報表
  rankingReportContent: document.getElementById('ranking-report-content'),
  metricCardsContainer: document.getElementById('metric-cards-container'),
  rankingTable: document.getElementById('ranking-table'),
  priceBandReportContent: document.getElementById('price-band-report-content'),
  priceBandTable: document.getElementById('price-band-table'),
  unitPriceReportContent: document.getElementById('unit-price-report-content'),
  residentialStatsTableContainer: document.getElementById('residential-stats-table-container'),
  residentialStatsExtraInfo: document.getElementById('residential-stats-extra-info'),
  typeComparisonTableContainer: document.getElementById('type-comparison-table-container'),
  parkingReportContent: document.getElementById('parking-report-content'),
  parkingRatioTableContainer: document.getElementById('parking-ratio-table-container'),
  avgPriceByTypeTableContainer: document.getElementById('avg-price-by-type-table-container'),
  rampPlanePriceByFloorTableContainer: document.getElementById('ramp-plane-price-by-floor-table-container'),
  velocityReportContent: document.getElementById('velocity-report-content'),
  velocityRoomFilterContainer: document.getElementById('velocity-room-filter-container'),
  velocitySubTabsContainer: document.getElementById('velocity-sub-tabs-container'),
  velocityTableContainer: document.getElementById('velocity-table-container'),
  // 資料列表
  dataListContent: document.getElementById('data-list-content'),
  resultsTable: document.getElementById('results-table'),
  paginationControls: document.getElementById('pagination-controls'),
  // Modal
  modal: document.getElementById('details-modal'),
  modalTitle: document.getElementById('modal-title'),
  modalContent: document.getElementById('modal-content'),
  modalCloseBtn: document.getElementById('modal-close-btn'),
  // 建案複選
  projectNameContainer: document.getElementById('project-name-container'),
  projectNameInput: document.getElementById('project-name-input'),
  projectNameSuggestions: document.getElementById('project-name-suggestions'),
  clearProjectsBtn: document.getElementById('clear-projects-btn'),
  // 平均數切換
  avgTypeToggle: document.getElementById('avg-type-toggle'),
};

// State variables
let currentPage = 1, pageSize = 30, totalRecords = 0;
let selectedProjects = [], suggestionDebounceTimer;
let analysisDataCache = null;
let currentSort = { key: 'saleAmountSum', order: 'desc' };
let currentAverageType = 'arithmetic';
let currentVelocityView = 'monthly';
let selectedVelocityRooms = [];

// Data
const districtData = {"臺北市":[...],"新北市":[...],"桃園市":[...],"臺中市":[...],"臺南市":[...],"高雄市":[...],"基隆市":[...],"新竹市":[...],"嘉義市":[...],"宜蘭縣":[...],"新竹縣":[...],"苗栗縣":[...],"彰化縣":[...],"南投縣":[...],"雲林縣":[...],"嘉義縣":[...],"屏東縣":[...],"花蓮縣":[...],"臺東縣":[...],"澎-湖縣":[...],"金門縣":[...],"連江縣":[...]};
const countyCodeMap = { "臺北市": "A", "新北市": "F", "桃園市": "H", "臺中市": "B", "臺南市": "D", "高雄市": "E", "基隆市": "C", "新竹市": "O", "嘉義市": "I", "新竹縣": "J", "苗栗縣": "K", "彰化縣": "N", "南投縣": "M", "雲林縣": "P", "嘉義縣": "Q", "屏東縣": "T", "宜蘭縣": "G", "花蓮縣": "U", "臺東縣": "V", "澎湖縣": "X", "金門縣": "W", "連江縣": "Z" };

// --- Event Listeners & Initializers ---
function initialize() {
  Object.keys(districtData).forEach(name => dom.countySelect.add(new Option(name, name)));
  dom.searchBtn.addEventListener('click', () => { currentPage = 1; fetchData(); });
  dom.analyzeBtn.addEventListener('click', analyzeData);
  dom.countySelect.addEventListener('change', updateDistrictOptions);
  dom.typeSelect.addEventListener('change', toggleAnalyzeButtonState);
  dom.dateRangeSelect.addEventListener('change', handleDateRangeChange);
  dom.dateStartInput.addEventListener('input', () => { if (document.activeElement === dom.dateStartInput) dom.dateRangeSelect.value = 'custom'; });
  dom.dateEndInput.addEventListener('input', () => { if (document.activeElement === dom.dateEndInput) dom.dateRangeSelect.value = 'custom'; });
  dom.modalCloseBtn.addEventListener('click', () => dom.modal.classList.add('hidden'));
  dom.resultsTable.addEventListener('click', e => { if (e.target.closest('.details-btn')) showSubTableDetails(e.target.closest('.details-btn')); });
  dom.projectNameInput.addEventListener('input', onProjectInput);
  dom.projectNameSuggestions.addEventListener('click', onSuggestionClick);
  dom.projectNameContainer.addEventListener('click', onTagRemove);
  document.addEventListener('click', e => { if (!dom.projectNameContainer.parentElement.contains(e.target)) dom.projectNameSuggestions.classList.add('hidden'); });
  dom.clearProjectsBtn.addEventListener('click', clearSelectedProjects);
  dom.tabsContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) switchTab(e.target.dataset.tab); });
  dom.rankingTable.addEventListener('click', e => {
    const header = e.target.closest('.sortable-th');
    if (!header) return;
    const sortKey = header.dataset.sortKey;
    if (currentSort.key === sortKey) {
      currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
    } else {
      currentSort.key = sortKey;
      currentSort.order = 'desc';
    }
    renderRankingReport();
  });
  dom.avgTypeToggle.addEventListener('click', (e) => {
    if (e.target.matches('.avg-type-btn')) {
      const type = e.target.dataset.type;
      switchAverageType(type);
    }
  });
  dom.velocityRoomFilterContainer.addEventListener('click', handleVelocityRoomFilterClick);
  dom.velocitySubTabsContainer.addEventListener('click', handleVelocitySubTabClick);
  toggleAnalyzeButtonState();
}

function switchAverageType(type) {
    if (currentAverageType === type || !type) return;
    currentAverageType = type;
    dom.avgTypeToggle.querySelector('.avg-type-btn.active').classList.remove('active');
    dom.avgTypeToggle.querySelector(`.avg-type-btn[data-type="${type}"]`).classList.add('active');
    if (analysisDataCache) {
        renderUnitPriceReport();
    }
}

// --- UI & State Management ---
function switchTab(targetTab) {
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
  document.getElementById(`${targetTab}-content`).classList.add('active');
  document.querySelector(`button[data-tab="${targetTab}"]`).classList.add('active');
}

function getFilters() {
    const filters = {};
    if (dom.countySelect.value) filters.countyCode = countyCodeMap[dom.countySelect.value] || '';
    if (dom.districtSelect.value) filters.district = dom.districtSelect.value;
    if (dom.typeSelect.value) filters.type = dom.typeSelect.value;
    if (dom.dateStartInput.value) filters.dateStart = dom.dateStartInput.value;
    if (dom.dateEndInput.value) filters.dateEnd = dom.dateEndInput.value;
    if (dom.buildingTypeSelect.value) filters.buildingType = dom.buildingTypeSelect.value;
    if (selectedProjects.length > 0) filters.projectNames = selectedProjects;
    return filters;
}

function showLoading(message) {
    dom.messageArea.innerHTML = `<div class="loader mx-auto"></div><p class="mt-4">${message}</p>`;
    dom.messageArea.classList.remove('hidden');
    dom.tabsContainer.classList.add('hidden');
    ['ranking-report-content', 'price-band-report-content', 'unit-price-report-content', 'parking-report-content', 'velocity-report-content', 'data-list-content'].forEach(id => document.getElementById(id).classList.remove('active'));
}

function showMessage(message, isError = false) {
    const messageClass = isError ? 'bg-red-900/50 border border-red-700 text-red-200 p-4 rounded-lg' : '';
    dom.messageArea.innerHTML = `<div class="${messageClass}">${message}</div>`;
    dom.messageArea.classList.remove('hidden');
    dom.tabsContainer.classList.add('hidden');
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function handleDateRangeChange() {
    const value = dom.dateRangeSelect.value;
    if (value === 'custom') return;
    const endDate = new Date();
    let startDate = new Date();
    switch (value) {
        case '7d': startDate.setDate(endDate.getDate() - 7); break;
        case '14d': startDate.setDate(endDate.getDate() - 14); break;
        case '30d': startDate.setDate(endDate.getDate() - 30); break;
        case '1q': startDate.setMonth(endDate.getMonth() - 3); break;
        case '2q': startDate.setMonth(endDate.getMonth() - 6); break;
        case '3q': startDate.setMonth(endDate.getMonth() - 9); break;
        case '1y': startDate.setFullYear(endDate.getFullYear() - 1); break;
        case 'this_year': startDate = new Date(endDate.getFullYear(), 0, 1); break;
        case 'last_2_years': startDate = new Date(endDate.getFullYear() - 1, 0, 1); break;
        case 'last_3_years': startDate = new Date(endDate.getFullYear() - 2, 0, 1); break;
    }
    dom.dateStartInput.value = formatDate(startDate);
    dom.dateEndInput.value = formatDate(endDate);
}

// --- Data Fetching & Analysis ---
async function analyzeData() {
  if (!dom.countySelect.value) return showMessage('請先選擇一個縣市再進行分析。');
  showLoading('分析中，請稍候...');
  try {
    const response = await fetch(RANKING_ANALYSIS_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ...' }, // 您的金鑰
      body: JSON.stringify({ filters: getFilters() })
    });
    if (!response.ok) {
      const err = await response.json().catch(() => ({ error: `分析請求失敗: ${response.status}` }));
      throw new Error(err.error);
    }
    analysisDataCache = await response.json();
    if (!analysisDataCache.coreMetrics) return showMessage('找不到符合條件的分析資料。');
    
    dom.messageArea.classList.add('hidden');
    dom.tabsContainer.classList.remove('hidden');
    currentSort = { key: 'saleAmountSum', order: 'desc' };
    
    renderRankingReport();
    renderPriceBandReport();
    renderUnitPriceReport();
    renderParkingAnalysisReport();
    renderSalesVelocityReport();
    
    switchTab('ranking-report');
  } catch(error) {
    console.error("數據分析失敗:", error);
    showMessage(`數據分析失敗: ${error.message}`, true);
    analysisDataCache = null;
  }
}

// fetchData 函式 (內容不變)

// --- Rendering Functions ---
function formatNumber(num, decimals = 2) {
    if (typeof num !== 'number' || isNaN(num)) return '-';
    return num.toLocaleString('zh-TW', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
}

// renderRankingReport, renderPriceBandReport, renderUnitPriceReport, renderParkingAnalysisReport 函式 (內容不變)

// --- 去化時間分析渲染邏輯 ---
function renderSalesVelocityReport() {
    const container = dom.velocityReportContent;
    if (!analysisDataCache || !analysisDataCache.salesVelocityAnalysis) {
        container.innerHTML = '<p class="text-gray-500 p-4 text-center">無去化時間資料可供分析。</p>';
        return;
    }

    // 重新渲染完整結構，避免舊的監聽器殘留
    container.innerHTML = `
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">房型篩選器</label>
            <div id="velocity-room-filter-container" class="flex flex-wrap gap-2"></div>
        </div>
        <div id="velocity-sub-tabs-container">
            <nav class="sub-tab-nav">
                <button data-view="weekly" class="sub-tab-btn">每週去化</button>
                <button data-view="monthly" class="sub-tab-btn active">每月去化</button>
                <button data-view="quarterly" class="sub-tab-btn">每季去化</button>
                <button data-view="yearly" class="sub-tab-btn">年度去化</button>
            </nav>
        </div>
        <div id="velocity-table-container" class="overflow-x-auto"></div>
    `;
    
    // 重新綁定 dom 物件中的元素
    dom.velocityRoomFilterContainer = document.getElementById('velocity-room-filter-container');
    dom.velocitySubTabsContainer = document.getElementById('velocity-sub-tabs-container');
    dom.velocityTableContainer = document.getElementById('velocity-table-container');

    const { allRoomTypes } = analysisDataCache.salesVelocityAnalysis;

    if (allRoomTypes && allRoomTypes.length > 0) {
        selectedVelocityRooms = [...allRoomTypes]; // 預設全選
        dom.velocityRoomFilterContainer.innerHTML = allRoomTypes.map(roomType => 
            `<button class="capsule-btn active" data-room-type="${roomType}">${roomType}</button>`
        ).join('');
    } else {
        dom.velocityRoomFilterContainer.innerHTML = '<p class="text-gray-500 text-sm">無可用房型</p>';
    }

    renderVelocityTable();
}

function renderVelocityTable() {
    if (!analysisDataCache || !analysisDataCache.salesVelocityAnalysis) return;

    const dataForView = analysisDataCache.salesVelocityAnalysis[currentVelocityView] || {};
    const timeKeys = Object.keys(dataForView).sort().reverse();

    let headerHtml = '<thead><tr class="bg-dark-card">';
    headerHtml += `<th rowspan="2" class="sticky left-0 bg-dark-card z-10">時間</th>`;
    
    selectedVelocityRooms.forEach(roomType => {
        headerHtml += `<th colspan="3" class="text-center border-l border-r border-gray-700">${roomType}</th>`;
    });
    headerHtml += `<th colspan="3" class="text-center font-bold text-cyan-400 border-l border-gray-700">總計</th>`;
    headerHtml += '</tr><tr class="bg-dark-card">';

    const subHeaders = ['資料筆數', '產權總價(萬)', '房屋坪數(坪)'];
    selectedVelocityRooms.forEach(() => {
        subHeaders.forEach(sub => headerHtml += `<th class="border-l border-gray-700">${sub}</th>`);
    });
    subHeaders.forEach(sub => headerHtml += `<th class="font-bold text-cyan-400 border-l border-gray-700">${sub}</th>`);
    headerHtml += '</tr></thead>';

    let bodyHtml = '<tbody>';
    timeKeys.forEach(timeKey => {
        const periodData = dataForView[timeKey];
        let rowTotal = { count: 0, priceSum: 0, areaSum: 0 };
        
        let rowHtml = `<tr class="hover:bg-dark-card"><td class="sticky left-0 bg-dark-card hover:bg-gray-800 z-10 font-mono">${timeKey}</td>`;
        
        selectedVelocityRooms.forEach(roomType => {
            const stats = periodData[roomType];
            if (stats) {
                rowHtml += `<td class="border-l border-gray-700">${stats.count.toLocaleString()}</td><td>${formatNumber(stats.priceSum, 0)}</td><td>${formatNumber(stats.areaSum, 2)}</td>`;
                rowTotal.count += stats.count;
                rowTotal.priceSum += stats.priceSum;
                rowTotal.areaSum += stats.areaSum;
            } else {
                rowHtml += `<td class="border-l border-gray-700">-</td><td>-</td><td>-</td>`;
            }
        });

        rowHtml += `<td class="font-semibold border-l border-gray-700">${rowTotal.count.toLocaleString()}</td><td class="font-semibold">${formatNumber(rowTotal.priceSum, 0)}</td><td class="font-semibold">${formatNumber(rowTotal.areaSum, 2)}</td>`;
        rowHtml += '</tr>';
        bodyHtml += rowHtml;
    });
    bodyHtml += '</tbody>';

    dom.velocityTableContainer.innerHTML = timeKeys.length > 0
        ? `<table class="min-w-full divide-y divide-gray-800">${headerHtml}${bodyHtml}</table>`
        : '<p class="text-gray-500 p-4 text-center">在此條件下無資料。</p>';
}

function handleVelocityRoomFilterClick(e) {
    const button = e.target.closest('.capsule-btn');
    if (!button) return;

    const roomType = button.dataset.roomType;
    button.classList.toggle('active');

    if (button.classList.contains('active')) {
        if (!selectedVelocityRooms.includes(roomType)) {
            selectedVelocityRooms.push(roomType);
        }
    } else {
        selectedVelocityRooms = selectedVelocityRooms.filter(r => r !== roomType);
    }
    
    const { allRoomTypes } = analysisDataCache.salesVelocityAnalysis;
    selectedVelocityRooms.sort((a, b) => allRoomTypes.indexOf(a) - allRoomTypes.indexOf(b));

    renderVelocityTable();
}

function handleVelocitySubTabClick(e) {
    const button = e.target.closest('.sub-tab-btn');
    if (!button) return;

    currentVelocityView = button.dataset.view;
    
    dom.velocitySubTabsContainer.querySelector('.active').classList.remove('active');
    button.classList.add('active');

    renderVelocityTable();
}

// 其他 renderTable, renderPagination, showSubTableDetails 等函式 (內容不變)

initialize();
</script>
</body>
</html>
