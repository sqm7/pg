<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不動產數據查詢平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1d29',
                        'dark-card': '#252836',
                        'cyan-accent': '#06b6d4',
                        'purple-accent': '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: #1a1d29;
            color: #e5e7eb;
        }
        .glass-card {
            background: rgba(37, 40, 54, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-input, .form-select {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #d1d5db;
        }
        .form-input:focus, .form-select:focus {
            border-color: #06b6d4;
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.5);
            outline: none;
        }
        .loader { border: 4px solid #374151; border-top: 4px solid #06b6d4; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); transition: opacity 0.3s ease; }
        .modal-container { background: #1a1d29; padding: 1.5rem; border-radius: 12px; width: 95%; max-width: 1400px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid #4b5563; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay:not(.hidden) .modal-container { transform: scale(1); }
        
        /* Analysis Report Table Styles */
        .analysis-table th { cursor: pointer; user-select: none; }
        .analysis-table th:hover { background-color: #374151; }
        .analysis-table th.sorted { background-color: #06b6d4; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-white tracking-tight">不動產數據查詢平台</h1>
            <p class="mt-2 text-lg text-gray-400">您的專屬數據查詢與分析工具。</p>
        </header>
        
        <main>
            <!-- Filter Form (Assuming this part is the same) -->
            <div class="glass-card p-6 rounded-xl shadow-lg mb-8">
                <div id="filter-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 items-end">
                    <div>
                        <label for="county" class="block text-sm font-medium text-gray-300">縣市</label>
                        <select id="county" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                            <option value="">請選擇縣市</option>
                        </select>
                    </div>
                    <div>
                        <label for="building-type" class="block text-sm font-medium text-gray-300">建物型態</label>
                        <select id="building-type" class="form-select mt-1 block w-full pl-3 pr-10 py-2 text-base rounded-md">
                            <option value="">全部</option>
                            <option value="住宅大樓(11層含以上有電梯)">住宅大樓</option>
                            <option value="華廈(10層含以下有電梯)">華廈</option>
                            <option value="公寓(5層含以下無電梯)">公寓</option>
                            <option value="套房(1房(1廳)1衛)">套房</option>
                        </select>
                    </div>
                    <div class="xl:col-span-2">
                        <label for="project-name-input" class="block text-sm font-medium text-gray-300">建案名稱 (可複選)</label>
                        <input type="text" id="project-name-input" placeholder="輸入建案, 以逗號分隔" class="form-input mt-1 block w-full rounded-md">
                    </div>
                    <div class="sm:col-span-2 lg:col-span-4 xl:col-span-6 flex justify-end items-center gap-4">
                        <button id="analyze-btn" class="bg-gradient-to-r from-cyan-accent to-purple-accent text-white font-bold py-2 px-6 rounded-lg shadow-lg hover:opacity-90 transition-all">
                            數據分析
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Analysis Report Modal -->
    <div id="analysis-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">預售屋分析報告 - 核心指標與排名</h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="modal-content" class="flex-grow overflow-y-auto">
                <!-- Content will be rendered here by JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const dom = {
            countySelect: document.getElementById('county'),
            buildingTypeSelect: document.getElementById('building-type'),
            projectNameInput: document.getElementById('project-name-input'),
            analyzeBtn: document.getElementById('analyze-btn'),
            analysisModal: document.getElementById('analysis-modal'),
            modalContent: document.getElementById('modal-content'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
        };

        // --- API Endpoint ---
        const ANALYSIS_ENDPOINT = 'https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/analyze-data';

        // --- State ---
        let currentSortBy = 'total_price'; // 預設排序欄位

        // --- County Data ---
        const countyCodeMap = { "臺北市": "A", "新北市": "F", "桃園市": "H", "臺中市": "B", "臺南市": "D", "高雄市": "E", "基隆市": "C", "新竹市": "O", "嘉義市": "I", "新竹縣": "J", "苗栗縣": "K", "彰化縣": "N", "南投縣": "M", "雲林縣": "P", "嘉義縣": "Q", "屏東縣": "T", "宜蘭縣": "G", "花蓮縣": "U", "臺東縣": "V", "澎湖縣": "X", "金門縣": "W", "連江縣": "Z" };

        // --- Initialization ---
        function initialize() {
            // 填充縣市下拉選單
            Object.keys(countyCodeMap).forEach(countyName => {
                const option = document.createElement('option');
                option.value = countyName;
                option.textContent = countyName;
                dom.countySelect.appendChild(option);
            });

            // 綁定事件監聽器
            dom.analyzeBtn.addEventListener('click', () => analyzeData(currentSortBy));
            dom.modalCloseBtn.addEventListener('click', () => dom.analysisModal.classList.add('hidden'));
            // 監聽 modal 內容的點擊事件，用於處理排序
            dom.modalContent.addEventListener('click', handleSortClick);
        }

        // --- Main Analysis Function ---
        async function analyzeData(sortBy = 'total_price') {
            const county = dom.countySelect.value;
            if (!county) {
                alert('請先選擇一個縣市');
                return;
            }

            currentSortBy = sortBy; // 更新當前排序狀態

            // 顯示載入中的 modal
            dom.analysisModal.classList.remove('hidden');
            dom.modalContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';

            // 收集篩選條件
            const projectNames = dom.projectNameInput.value.split(',').map(name => name.trim()).filter(Boolean);
            const requestFilters = {
                countyCode: countyCodeMap[county],
                buildingType: dom.buildingTypeSelect.value || null,
                projectNames: projectNames.length > 0 ? projectNames : null
            };

            try {
                const response = await fetch(ANALYSIS_ENDPOINT, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4Ym1iYmZyemJ0dXVleXNpY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2ODg5ODksImV4cCI6MjA2NjI2NDk4OX0.1IUynv5eK1xF_3pb-oasqaTrPvbeAOC4Sc1oykPBy4M'
                    },
                    body: JSON.stringify({
                        filters: requestFilters,
                        tab: 'core_and_ranking',
                        sortBy: currentSortBy
                    })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `伺服器錯誤: ${response.status}`);
                }

                const data = await response.json();
                renderAnalysisReport(data);

            } catch (error) {
                console.error("數據分析失敗:", error);
                dom.modalContent.innerHTML = `<div class="p-8 text-center text-red-400">數據分析失敗: ${error.message}</div>`;
            }
        }

        // --- Rendering Functions ---
        function renderAnalysisReport(data) {
            if (!data) {
                dom.modalContent.innerHTML = '<div class="p-8 text-center">找不到符合條件的分析資料。</div>';
                return;
            }

            const { core_metrics, project_ranking, ranking_summary } = data;
            
            // 使用 toLocaleString 來格式化數字
            const formatNumber = (num, digits = 2) => {
                if (typeof num !== 'number') return '-';
                return num.toLocaleString('en-US', { minimumFractionDigits: digits, maximumFractionDigits: digits });
            };

            const metricsHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">市場去化總銷售金額</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['市場去化總銷售金額'], 0)} <span class="text-base font-normal text-gray-400">萬</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">總銷去化房屋坪數</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['總銷去化房屋坪數'], 0)} <span class="text-base font-normal text-gray-400">坪</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">總行政區平均單價</h3>
                        <p class="text-2xl font-bold text-white">${formatNumber(core_metrics?.['總行政區平均單價'])} <span class="text-base font-normal text-gray-400">萬/坪</span></p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <h3 class="text-sm font-medium text-gray-400">行政區去化筆數</h3>
                        <p class="text-2xl font-bold text-white">${(core_metrics?.['行政區去化筆數'] || 0).toLocaleString()} <span class="text-base font-normal text-gray-400">筆</span></p>
                    </div>
                </div>
            `;
            
            // 標頭和對應的排序鍵
            const headers = [
                { label: '排名', sortKey: null },
                { label: '建案名稱', sortKey: null },
                { label: '房屋面積(坪)', sortKey: 'total_area' },
                { label: '資料筆數', sortKey: 'transaction_count' },
                { label: '交易總價(萬)', sortKey: 'total_price' },
                { label: '市場佔比(%)', sortKey: null },
                { label: '平均單價(萬)', sortKey: 'avg_unit_price' },
                { label: '最低單價(萬)', sortKey: null },
                { label: '最高單價(萬)', sortKey: null },
                { label: '單價中位數(萬)', sortKey: null },
                { label: '車位平均單價', sortKey: null },
            ];

            const tableHeaderHTML = headers.map(h => {
                const isSortable = h.sortKey !== null;
                const isSorted = h.sortKey === currentSortBy;
                return `<th class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider ${isSortable ? 'hover:bg-gray-700' : ''} ${isSorted ? 'bg-cyan-600 text-white' : ''}" ${isSortable ? `data-sort="${h.sortKey}"` : ''}>
                    ${h.label} ${isSortable ? '🔽' : ''}
                </th>`;
            }).join('');

            const tableRowsHTML = project_ranking?.map(row => `
                <tr class="border-b border-gray-700 hover:bg-dark-card">
                    <td class="p-3 text-sm">${row['排名']}</td>
                    <td class="p-3 text-sm font-medium text-cyan-400">${row['建案名稱']}</td>
                    <td class="p-3 text-sm">${formatNumber(row['房屋面積(坪)'], 2)}</td>
                    <td class="p-3 text-sm">${row['資料筆數']}</td>
                    <td class="p-3 text-sm">${formatNumber(row['交易總價(萬)'], 0)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['市場佔比(%)'], 2)}%</td>
                    <td class="p-3 text-sm font-bold">${formatNumber(row['平均單價(萬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['最低單價(萬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['最高單價(萬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['單價中位數(萬)'], 2)}</td>
                    <td class="p-3 text-sm">${formatNumber(row['車位平均單價'], 2)}</td>
                </tr>
            `).join('') || '<tr><td colspan="11" class="p-8 text-center">無建案排名資料</td></tr>';

            const summaryRowHTML = `
                <tr class="bg-dark-card font-bold">
                    <td class="p-3 text-sm" colspan="2">總計 (篩選後所有資料)</td>
                    <td class="p-3 text-sm">${formatNumber(ranking_summary?.['房屋面積_總和'], 2)}</td>
                    <td class="p-3 text-sm">${(ranking_summary?.['資料筆數_總和'] || 0).toLocaleString()}</td>
                    <td class="p-3 text-sm">${formatNumber(ranking_summary?.['交易總價_總和'], 0)}</td>
                    <td class="p-3 text-sm" colspan="6"></td>
                </tr>
            `;

            const tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full analysis-table">
                        <thead class="bg-gray-800">
                            <tr>${tableHeaderHTML}</tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            ${tableRowsHTML}
                        </tbody>
                        <tfoot>
                            ${summaryRowHTML}
                        </tfoot>
                    </table>
                </div>
            `;

            dom.modalContent.innerHTML = metricsHTML + tableHTML;
        }
        
        // --- Event Handlers ---
        function handleSortClick(e) {
            const header = e.target.closest('th');
            if (header && header.dataset.sort) {
                const sortBy = header.dataset.sort;
                analyzeData(sortBy);
            }
        }

        // --- Run Initialization ---
        initialize();
    </script>
</body>
</html>
